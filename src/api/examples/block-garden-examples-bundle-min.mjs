function g(g,I){return Math.floor(Math.random()*(I-g+1))+g}const I={A:["0110","1001","1111","1001","1001"],B:["1110","1001","1110","1001","1110"],C:["0111","1000","1000","1000","0111"],D:["1110","1001","1001","1001","1110"],E:["1111","1000","1110","1000","1111"],F:["1111","1000","1110","1000","1000"],G:["0111","1000","1011","1001","0111"],H:["1001","1001","1111","1001","1001"],I:["111","010","010","010","111"],J:["0011","0001","0001","1001","0110"],K:["1001","1010","1100","1010","1001"],L:["1000","1000","1000","1000","1111"],M:["10001","11011","10101","10001","10001"],N:["1001","1101","1011","1001","1001"],O:["0110","1001","1001","1001","0110"],P:["1110","1001","1110","1000","1000"],Q:["0110","1001","1001","1011","0111"],R:["1110","1001","1110","1010","1001"],S:["01110","10000","01100","00010","11100"],T:["11111","00100","00100","00100","00100"],U:["1001","1001","1001","1001","0110"],V:["10001","10001","10001","01010","00100"],W:["10001","10001","10101","11011","10001"],X:["1001","1001","0110","1001","1001"],Y:["1001","1001","0110","0010","0010"],Z:["1111","0010","0100","1000","1111"],0:["0110","1001","1001","1001","0110"],1:["010","110","010","010","111"],2:["1110","0001","1110","1000","1111"],3:["1110","0001","1110","0001","1110"],4:["1001","1001","1111","0001","0001"],5:["1111","1000","1110","0001","1110"],6:["0110","1000","1110","1001","0110"],7:["1111","0001","0010","0100","0100"],8:["0110","1001","0110","1001","0110"],9:["0110","1001","0111","0001","0110"],",":["0","0","0","10","10"],".":["0","0","0","0","1"],"?":["1110","0001","0110","0000","0100"],"!":["1","1","1","0","1"]," ":["0","0","0","0","0"],"-":["0","0","1111","0","0"],"/":["0001","0010","0100","1000","0000"],":":["0","1","0","1","0"],"@":["0110","1011","1011","1000","0111"],"Ä":["01010","0110","1001","1111","1001"],"Ö":["01010","0110","1001","1001","0110"],"Ü":["01010","1001","1001","1001","0110"],"ß":["1100","1010","1110","1010","1100"],"À":["0100","0110","1111","1001","1001"],"Â":["0100","1010","1111","1001","1001"],"Æ":["01111","10100","11110","10100","11111"],"Ç":["0111","1000","1000","1000","0111","0010"],"É":["0100","1111","1000","1110","1000"],"È":["0100","1111","1000","1110","1000"],"Ê":["0100","1010","1111","1000","1111"],"Ë":["01010","1111","1000","1110","1000"],"Î":["010","101","010","010","111"],"Ï":["101","010","010","010","111"],"Ô":["0100","1010","0110","1001","0110"],"Œ":["01111","10100","10110","10100","01111"],"Ù":["0100","1001","1001","1001","0110"],"Û":["0100","1010","1001","1001","0110"],"Ÿ":["101","1001","0110","0010","0010"],"Ñ":["10101","11011","10111","10011","10001"],"¿":["0010","0000","0110","1000","0111"],"¡":["0","1","0","1","1"]};async function C(g){if("number"!=typeof g||Number.isNaN(g))throw new TypeError("ms must be a valid number");if(g<0)throw new RangeError("ms must be non-negative");return new Promise(I=>setTimeout(I,g))}function A(g,I){const C=g.createElement("canvas").getContext("2d");C.fillStyle=I;const A=C.fillStyle,o=A.match(/^#([0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/i);if(o){let g=o[1];3!==g.length&&4!==g.length||(g=g.split("").map(g=>g+g).join(""));return[parseInt(g.substring(0,2),16),parseInt(g.substring(2,4),16),parseInt(g.substring(4,6),16)]}const S=A.match(/^rgba?\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)/i);return S?[parseInt(S[1]),parseInt(S[2]),parseInt(S[3])]:[0,0,0]}function o(g,I,C,A){let o=1/0,S=g[0];for(const s of g){const g=(I-s[0])**2+(C-s[1])**2+(A-s[2])**2;g<o&&(o=g,S=s)}return S}function S(g,I,C){const A=g=>{const I=g.toString(16);return 1===I.length?"0"+I:I};return"#"+A(g)+A(I)+A(C)}const s={13:"Enter",16:"Shift",17:"Control",32:" ",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",192:"`"},t={...s,13:"Enter",16:"ShiftLeft",17:"ControlLeft",32:"Space",48:"Digit0",49:"Digit1",50:"Digit2",51:"Digit3",52:"Digit4",53:"Digit5",54:"Digit6",55:"Digit7",56:"Digit8",57:"Digit9",65:"KeyA",66:"KeyB",67:"KeyC",68:"KeyD",69:"KeyE",70:"KeyF",71:"KeyG",72:"KeyH",73:"KeyI",74:"KeyJ",75:"KeyK",76:"KeyL",77:"KeyM",78:"KeyN",79:"KeyO",80:"KeyP",81:"KeyQ",82:"KeyR",83:"KeyS",84:"KeyT",85:"KeyU",86:"KeyV",87:"KeyW",88:"KeyX",89:"KeyY",90:"KeyZ",192:"Backquote"};function d(g,I,C=t,A=s){return new KeyboardEvent(g,{key:A[I]||"",code:C[I]||"",keyCode:I,which:I,bubbles:!0,cancelable:!0,composed:!0})}async function i(g,I,A=100){g.dispatchEvent(d("keydown",I)),await C(A),g.dispatchEvent(d("keyup",I))}const L={AIR:"Air",AGAVE_BASE:"Agave Base",AGAVE_FLOWER_STALK:"Agave Flower Stalk",AGAVE_FLOWER:"Agave Flower",AGAVE_GROWING:"Agave Growing",AGAVE_SPIKE:"Agave Spike",AGAVE:"Agave",BAMBOO_GROWING:"Bamboo Growing",BAMBOO_JOINT:"Bamboo Joint",BAMBOO_LEAVES:"Bamboo Leaves",BAMBOO_STALK:"Bamboo Stalk",BAMBOO:"Bamboo",BEDROCK:"Bedrock",BERRY_BUSH_BERRIES:"Berry Bush Berries",BERRY_BUSH_BRANCH:"Berry Bush Branch",BERRY_BUSH_GROWING:"Berry Bush Growing",BERRY_BUSH_LEAVES:"Berry Bush Leaves",BERRY_BUSH:"Berry Bush",BIRCH_BARK:"Birch Bark",BIRCH_BRANCHES:"Birch Branches",BIRCH_CATKINS:"Birch Catkins",BIRCH_GROWING:"Birch Growing",BIRCH_LEAVES:"Birch Leaves",BIRCH_TRUNK:"Birch Trunk",BIRCH:"Birch",CACTUS_BODY:"Cactus Body",CACTUS_FLOWER:"Cactus Flower",CACTUS_GROWING:"Cactus Growing",CACTUS:"Cactus",CARROT_GROWING:"Carrot Growing",CARROT_LEAVES:"Carrot Leaves",CARROT_ROOT:"Carrot Root",CARROT:"Carrot",CLAY:"Clay",CLOUD:"Cloud",COAL:"Coal",CORN_EAR:"Corn Ear",CORN_GROWING:"Corn Growing",CORN_LEAVES:"Corn Leaves",CORN_SILK:"Corn Silk",CORN_STALK:"Corn Stalk",CORN:"Corn",DIRT:"Dirt",FERN_FROND:"Fern Frond",FERN_GROWING:"Fern Growing",FERN_STEM:"Fern Stem",FERN:"Fern",GOLD:"Gold",GRASS:"Grass",ICE:"Ice",IRON:"Iron",KELP_BLADE:"Kelp Blade",KELP_BULB:"Kelp Bulb",KELP_GROWING:"Kelp Growing",KELP:"Kelp",LAVA:"Lava",LAVENDER_BUSH:"Lavender Bush",LAVENDER_FLOWERS:"Lavender Flowers",LAVENDER_GROWING:"Lavender Growing",LAVENDER_STEM:"Lavender Stem",LAVENDER:"Lavender",LOTUS_BUD:"Lotus Bud",LOTUS_FLOWER:"Lotus Flower",LOTUS_GROWING:"Lotus Growing",LOTUS_PAD:"Lotus Pad",LOTUS_STEM:"Lotus Stem",LOTUS:"Lotus",MOSS:"Moss",MUSHROOM_CAP:"Mushroom Cap",MUSHROOM_GROWING:"Mushroom Growing",MUSHROOM_STEM:"Mushroom Stem",MUSHROOM:"Mushroom",PINE_CONE:"Pine Cone",PINE_NEEDLES:"Pine Needles",PINE_TREE_GROWING:"Pine Tree Growing",PINE_TREE:"Pine Tree",PINE_TRUNK:"Pine Trunk",PUMICE:"Pumice",PUMPKIN_FRUIT:"Pumpkin Fruit",PUMPKIN_GROWING:"Pumpkin Growing",PUMPKIN_LEAVES:"Pumpkin Leaves",PUMPKIN_STEM:"Pumpkin Stem",PUMPKIN_VINE:"Pumpkin Vine",PUMPKIN:"Pumpkin",ROSE_BLOOM:"Rose Bloom",ROSE_BUD:"Rose Bud",ROSE_GROWING:"Rose Growing",ROSE_LEAVES:"Rose Leaves",ROSE_STEM:"Rose Stem",ROSE_THORNS:"Rose Thorns",ROSE:"Rose",SAND:"Sand",SNOW:"Snow",STONE:"Stone",SUNFLOWER_CENTER:"Sunflower Center",SUNFLOWER_GROWING:"Sunflower Growing",SUNFLOWER_LEAVES:"Sunflower Leaves",SUNFLOWER_PETALS:"Sunflower Petals",SUNFLOWER_STEM:"Sunflower Stem",SUNFLOWER:"Sunflower",TREE_GROWING:"Tree Growing",TREE_LEAVES:"Tree Leaves",TREE_TRUNK:"Tree Trunk",TULIP_BULB:"Tulip Bulb",TULIP_GROWING:"Tulip Growing",TULIP_LEAVES:"Tulip Leaves",TULIP_PETALS:"Tulip Petals",TULIP_STEM:"Tulip Stem",TULIP:"Tulip",WATER:"Water",WHEAT_GRAIN:"Wheat Grain",WHEAT_GROWING:"Wheat Growing",WHEAT_STALK:"Wheat Stalk",WHEAT:"Wheat",WILLOW_BRANCHES:"Willow Branches",WILLOW_LEAVES:"Willow Leaves",WILLOW_TREE_GROWING:"Willow Tree Growing",WILLOW_TREE:"Willow Tree",WILLOW_TRUNK:"Willow Trunk",WOOD:"Wood",LINK:"Link"},l=[{name:L.AIR,id:0,drops:null,solid:!1},{name:L.AGAVE_BASE,id:82,drops:null,solid:!0},{name:L.AGAVE_FLOWER_STALK,id:84,drops:null,solid:!0},{name:L.AGAVE_FLOWER,id:85,drops:null,solid:!0},{name:L.AGAVE_GROWING,id:81,drops:null,solid:!0,crop:!0},{name:L.AGAVE_SPIKE,id:83,drops:null,solid:!0},{name:L.AGAVE,id:80,drops:"AGAVE",solid:!0,growthTime:1920,isSeed:!0,crop:!0},{name:L.BAMBOO_GROWING,id:43,drops:null,solid:!0,crop:!0},{name:L.BAMBOO_JOINT,id:53,drops:null,solid:!0},{name:L.BAMBOO_LEAVES,id:54,drops:null,solid:!0},{name:L.BAMBOO_STALK,id:52,drops:null,solid:!0},{name:L.BAMBOO,id:36,drops:"BAMBOO",solid:!0,growthTime:180,isSeed:!0,crop:!0},{name:L.BEDROCK,id:19,drops:null,solid:!0},{name:L.BERRY_BUSH_BERRIES,id:51,drops:null,solid:!0},{name:L.BERRY_BUSH_BRANCH,id:49,drops:null,solid:!0},{name:L.BERRY_BUSH_GROWING,id:42,drops:null,solid:!0,crop:!0},{name:L.BERRY_BUSH_LEAVES,id:50,drops:null,solid:!0},{name:L.BERRY_BUSH,id:35,drops:"BERRY_BUSH",solid:!0,growthTime:360,isSeed:!0,crop:!0},{name:L.BIRCH_BARK,id:117,drops:null,solid:!0},{name:L.BIRCH_BRANCHES,id:118,drops:null,solid:!0},{name:L.BIRCH_CATKINS,id:120,drops:null,solid:!0},{name:L.BIRCH_GROWING,id:115,drops:null,solid:!0,crop:!0},{name:L.BIRCH_LEAVES,id:119,drops:null,solid:!0},{name:L.BIRCH_TRUNK,id:116,drops:null,solid:!0},{name:L.BIRCH,id:114,drops:["BIRCH","WOOD"],solid:!0,growthTime:1260,isSeed:!0,crop:!0},{name:L.CACTUS_BODY,id:30,drops:null,solid:!0},{name:L.CACTUS_FLOWER,id:31,drops:null,solid:!0},{name:L.CACTUS_GROWING,id:23,drops:null,solid:!0,crop:!0},{name:L.CACTUS,id:15,drops:"CACTUS",solid:!0,growthTime:2400,isSeed:!0,crop:!0},{name:L.CARROT_GROWING,id:21,drops:null,solid:!0,crop:!0},{name:L.CARROT_LEAVES,id:26,drops:null,solid:!0},{name:L.CARROT_ROOT,id:27,drops:null,solid:!0},{name:L.CARROT,id:13,drops:"CARROT",solid:!0,growthTime:240,isSeed:!0,crop:!0},{name:L.CLAY,id:6,drops:"CLAY",solid:!0},{name:L.CLOUD,id:72,drops:"CLOUD",solid:!0},{name:L.COAL,id:7,drops:"COAL",solid:!0},{name:L.CORN_EAR,id:61,drops:null,solid:!0},{name:L.CORN_GROWING,id:45,drops:null,solid:!0,crop:!0},{name:L.CORN_LEAVES,id:60,drops:null,solid:!0},{name:L.CORN_SILK,id:62,drops:null,solid:!0},{name:L.CORN_STALK,id:59,drops:null,solid:!0},{name:L.CORN,id:38,drops:"CORN",solid:!0,growthTime:420,isSeed:!0,crop:!0},{name:L.DIRT,id:2,drops:"DIRT",solid:!0},{name:L.FERN_FROND,id:70,drops:null,solid:!0},{name:L.FERN_GROWING,id:48,drops:null,solid:!0,crop:!0},{name:L.FERN_STEM,id:69,drops:null,solid:!0},{name:L.FERN,id:41,drops:"FERN",solid:!0,growthTime:90,isSeed:!0,crop:!0},{name:L.GOLD,id:9,drops:"GOLD",solid:!0},{name:L.GRASS,id:1,drops:"GRASS",solid:!0},{name:L.ICE,id:17,drops:"ICE",solid:!0},{name:L.IRON,id:8,drops:"IRON",solid:!0},{name:L.KELP_BLADE,id:93,drops:null,solid:!0},{name:L.KELP_BULB,id:94,drops:null,solid:!0},{name:L.KELP_GROWING,id:92,drops:null,solid:!0,crop:!0},{name:L.KELP,id:91,drops:"KELP",solid:!0,growthTime:150,isSeed:!0,crop:!0},{name:L.LAVA,id:18,drops:null,solid:!0,gravity:!0},{name:L.LAVENDER_BUSH,id:89,drops:null,solid:!0},{name:L.LAVENDER_FLOWERS,id:90,drops:null,solid:!0},{name:L.LAVENDER_GROWING,id:87,drops:null,solid:!0,crop:!0},{name:L.LAVENDER_STEM,id:88,drops:null,solid:!0},{name:L.LAVENDER,id:86,drops:"LAVENDER",solid:!0,growthTime:200,isSeed:!0,crop:!0},{name:L.LOTUS_BUD,id:112,drops:null,solid:!0},{name:L.LOTUS_FLOWER,id:113,drops:null,solid:!0},{name:L.LOTUS_GROWING,id:109,drops:null,solid:!0,crop:!0},{name:L.LOTUS_PAD,id:110,drops:null,solid:!0},{name:L.LOTUS_STEM,id:111,drops:null,solid:!0},{name:L.LOTUS,id:108,drops:"LOTUS",solid:!0,growthTime:390,isSeed:!0,crop:!0},{name:L.MUSHROOM_CAP,id:29,drops:null,solid:!0},{name:L.MUSHROOM_GROWING,id:22,drops:null,solid:!0,crop:!0},{name:L.MUSHROOM_STEM,id:28,drops:null,solid:!0},{name:L.MUSHROOM,id:14,drops:"MUSHROOM",solid:!0,growthTime:120,isSeed:!0,crop:!0},{name:L.PINE_CONE,id:65,drops:null,solid:!0},{name:L.PINE_NEEDLES,id:64,drops:null,solid:!0},{name:L.PINE_TREE_GROWING,id:46,drops:null,solid:!0,crop:!0},{name:L.PINE_TREE,id:39,drops:"PINE_TREE",solid:!0,growthTime:1440,isSeed:!0,crop:!0},{name:L.PINE_TRUNK,id:63,drops:null,solid:!0},{name:L.PUMICE,id:71,drops:"PUMICE",solid:!0},{name:L.PUMPKIN_FRUIT,id:106,drops:null,solid:!0},{name:L.PUMPKIN_GROWING,id:103,drops:null,solid:!0,crop:!0},{name:L.PUMPKIN_LEAVES,id:105,drops:null,solid:!0},{name:L.PUMPKIN_STEM,id:107,drops:null,solid:!0},{name:L.PUMPKIN_VINE,id:104,drops:null,solid:!0},{name:L.PUMPKIN,id:102,drops:"PUMPKIN",solid:!0,growthTime:660,isSeed:!0,crop:!0},{name:L.ROSE_BLOOM,id:101,drops:null,solid:!0},{name:L.ROSE_BUD,id:100,drops:null,solid:!0},{name:L.ROSE_GROWING,id:96,drops:null,solid:!0,crop:!0},{name:L.ROSE_LEAVES,id:99,drops:null,solid:!0},{name:L.ROSE_STEM,id:97,drops:null,solid:!0},{name:L.ROSE_THORNS,id:98,drops:null,solid:!0},{name:L.ROSE,id:95,drops:"ROSE",solid:!0,growthTime:540,isSeed:!0,crop:!0},{name:L.SAND,id:5,drops:"SAND",solid:!0,gravity:!0},{name:L.SNOW,id:16,drops:"SNOW",solid:!0},{name:L.STONE,id:3,drops:"STONE",solid:!0},{name:L.SUNFLOWER_CENTER,id:57,drops:null,solid:!0},{name:L.SUNFLOWER_GROWING,id:44,drops:null,solid:!0,crop:!0},{name:L.SUNFLOWER_LEAVES,id:56,drops:null,solid:!0},{name:L.SUNFLOWER_PETALS,id:58,drops:null,solid:!0},{name:L.SUNFLOWER_STEM,id:55,drops:"SUNFLOWER",solid:!0},{name:L.SUNFLOWER,id:37,drops:null,solid:!0,growthTime:600,isSeed:!0,crop:!0},{name:L.TREE_GROWING,id:34,drops:null,solid:!0,crop:!0},{name:L.TREE_LEAVES,id:11,drops:null,solid:!0,crop:!0},{name:L.TREE_TRUNK,id:10,drops:"WOOD",solid:!0,crop:!0},{name:L.TULIP_BULB,id:79,drops:null,solid:!0},{name:L.TULIP_GROWING,id:75,drops:null,solid:!0,crop:!0},{name:L.TULIP_LEAVES,id:77,drops:null,solid:!0},{name:L.TULIP_PETALS,id:78,drops:null,solid:!0},{name:L.TULIP_STEM,id:76,drops:null,solid:!0},{name:L.TULIP,id:74,drops:"TULIP",solid:!0,growthTime:300,isSeed:!0,crop:!0},{name:L.WATER,id:4,drops:null,solid:!0,gravity:!0},{name:L.WHEAT_GRAIN,id:25,drops:null,solid:!0},{name:L.WHEAT_GROWING,id:20,drops:null,solid:!0,crop:!0},{name:L.WHEAT_STALK,id:24,drops:null,solid:!0},{name:L.WHEAT,id:12,drops:"WHEAT",solid:!0,growthTime:480,isSeed:!0,crop:!0},{name:L.WILLOW_BRANCHES,id:67,drops:null,solid:!0},{name:L.WILLOW_LEAVES,id:68,drops:null,solid:!0},{name:L.WILLOW_TREE_GROWING,id:47,drops:null,solid:!0,crop:!0},{name:L.WILLOW_TREE,id:40,drops:["WILLOW_TREE","WOOD"],solid:!0,growthTime:1800,isSeed:!0,crop:!0},{name:L.WILLOW_TRUNK,id:66,drops:null,solid:!0},{name:L.WOOD,id:73,drops:"WOOD",solid:!0,crop:!0},{name:L.LINK,id:130,drops:null,solid:!0}],G=new Array(256).fill(void 0),B=new Map,c=new Map;l.forEach((g,I)=>{c.set(g.id,I),void 0!==g.id&&g.id<256&&(G[g.id]=g),g.name&&B.set(g.name,g)}),Object.assign(l,{getById:g=>G[g],getByName:g=>B.get(g)});class K{constructor(){this.gThis=globalThis,this.doc=this.gThis.document,this.config=this.gThis.blockGarden.config,this.state=this.gThis.blockGarden.state,this.computed=this.gThis.blockGarden.computed,this.blocks=this.config.blocks,this.blockBreakListeners=[],this.isInterceptingSetBlock=!1}get shadow(){return function(g,I){const C=(g,I)=>{if(!g)return null;if(g.tagName===I.toUpperCase()&&g.shadowRoot)return g;const A=[...g.children||[]];return g.shadowRoot&&A.push(g.shadowRoot),A.map(g=>C(g,I)).find(Boolean)||null},A=C(g,I);return A?A.shadowRoot:null}(this.doc,"block-garden")}getWorld(){return this.state.world}setWorld(g){this.state.world=g}getIdealColorMapForPixels(g,I,C,s=new Set){const t=function(g,I="--bg-",C="-color",A=g=>g){let o;for(const S of g){o||(o={});let s=S.slice(I.length);if(s=s.slice(0,C.length>0?-C.length:void 0),S.startsWith(I)){const I=A(s),C=g.getPropertyValue(S).trim().replace(/^['"]|['"]$/g,"");o[I]=C}}return o}(this.gThis.getComputedStyle(this.shadow.host),"--bg-block-"),d=[],i={},L=[];for(const[g,I]of Object.entries(t)){const C=this.normalizeBlockName(g);if(s.has(C))continue;const o=A(this.doc,I);o&&(d.push(o),i[o.join(",")]=C,L.push(C))}const l={},G={};for(const g of L)l[g]=[0,0,0],G[g]=0;for(let I=0;I<g.length;I+=4){const C=g[I],A=g[I+1],S=g[I+2];if(g[I+3]<128)continue;const s=i[o(d,C,A,S).join(",")];s&&(l[s][0]+=C,l[s][1]+=A,l[s][2]+=S,G[s]++)}const B={};for(const g of L){const I=G[g];if(I>0){const C=l[g].map(g=>Math.round(g/I));B[`--bg-block-${g.toLowerCase().replace(/_/g,"-")}-color`]=S(C[0],C[1],C[2])}}return B}getBlockNameFromCss(g){const I=g.replace("--bg-color-","").toLowerCase(),C=I.toUpperCase().replace(/-/g,"_");if(L[C])return C;for(const[g]of Object.entries(L))if(g.toLowerCase().replace(/_/g,"-")===I)return g;return null}getBlockIdByName(g,I=this.config.blocks){const C=I.find(I=>I.name===g);return C?C.id:-1}normalizeBlockName(g){return"string"!=typeof g?null:g.toUpperCase().replace(/-/g,"_")}isStringMap(g){return"object"==typeof g&&null!==g&&Object.values(g).every(g=>"string"==typeof g)}rotatePixels(g,I,C,A=0){if(0===A)return{pixels:g,width:I,height:C};const o=A*Math.PI/180,S=Math.abs(Math.cos(o)),s=Math.abs(Math.sin(o)),t=Math.floor(C*s+I*S),d=Math.floor(C*S+I*s),i=this.doc.createElement("canvas"),L=i.getContext("2d");i.width=I,i.height=C;const l=L.createImageData(I,C);l.data.set(g),L.putImageData(l,0,0);const G=this.doc.createElement("canvas");G.width=t,G.height=d;const B=G.getContext("2d");return B.save(),B.translate(t/2,d/2),B.rotate(o),B.drawImage(i,-I/2,-C/2),B.restore(),{pixels:B.getImageData(0,0,t,d).data,width:t,height:d}}getBlock(g,I,C){return this.getWorld().getBlock(g,I,C)}setBlock(g,I,C,A){const o=this.getWorld();o.setBlock(g,I,C,A,!0),this.setWorld(o)}batchSetBlocks(g){const I=this.getWorld();g.forEach(({x:g,y:C,z:A,block:o})=>I.setBlock(g,C,A,o,!0)),this.setWorld(I)}onBlockBreak(g){this.blockBreakListeners.push(g),this.isInterceptingSetBlock||this.setupBlockBreakInterception()}setupBlockBreakInterception(){this.isInterceptingSetBlock=!0;const g=this.getWorld(),I=g.setBlock.bind(g),C=this.getBlockIdByName("Air");g.setBlock=(g,A,o,S,s)=>{const t=I(g,A,o,S,s);return 0!==S&&S!==C||this.blockBreakListeners.forEach(I=>I(g,A,o)),t}}openUrl(g,I="_blank"){this.gThis.window?this.gThis.window.open(g,I):"undefined"!=typeof window?window.open(g,I):console.warn("⚠️ Navigation failed: No window object found.")}replaceWindow(g){this.gThis.window?this.gThis.window.location.href=g:"undefined"!=typeof window?window.location.href=g:console.warn("⚠️ Navigation failed: No window object found.")}drawText(g,C,A,o,S,s=this.getBlockIdByName("Dirt"),t=1,d=I,i=0){const L=[];let l=C,G=o;const B=i*Math.PI/180,c=Math.round(Math.cos(B)),K=Math.round(Math.sin(B));for(const I of g.toUpperCase()){const g=d[I];if(g){for(let I=0;I<g.length;I++)for(let C=0;C<g[I].length;C++){const o="1"===g[I][C]?S:s,t=A+(g.length-1-I),d=l+C*c,i=G+C*K;L.push({x:d,y:t,z:i,block:o})}for(let I=0;I<g.length;I++)for(let C=0;C<t;C++){const o=A+(g.length-1-I);L.push({x:l+(g[0].length+C)*c,y:o,z:G+(g[0].length+C)*K,block:s})}l+=(g[0].length+t)*c,G+=(g[0].length+t)*K}}return this.batchSetBlocks(L),{x:C,y:A,z:o,width:Math.abs(l-C)||Math.abs(G-o),height:5}}async getQRCodeModule(){const{qrcode:g}=await import("data:text/javascript;base64,Ly8gaHR0cHM6Ly9naXRodWIuY29tL2thenVoaWtvYXJhc2UvcXJjb2RlLWdlbmVyYXRvci8KLy8gaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMjUxMDIxMDI1MjE5L2h0dHBzOi8va2F6dWhpa29hcmFzZS5naXRodWIuaW8vcXJjb2RlLWdlbmVyYXRvci9qcy9kaXN0L3FyY29kZS5tanMKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8KLy8gUVIgQ29kZSBHZW5lcmF0b3IgZm9yIEphdmFTY3JpcHQKLy8KLy8gQ29weXJpZ2h0IChjKSAyMDA5IEthenVoaWtvIEFyYXNlCi8vCi8vIFVSTDogaHR0cDovL3d3dy5kLXByb2plY3QuY29tLwovLwovLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2U6Ci8vICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAovLwovLyBUaGUgd29yZCAnUVIgQ29kZScgaXMgcmVnaXN0ZXJlZCB0cmFkZW1hcmsgb2YKLy8gREVOU08gV0FWRSBJTkNPUlBPUkFURUQKLy8gIGh0dHA6Ly93d3cuZGVuc28td2F2ZS5jb20vcXJjb2RlL2ZhcXBhdGVudC1lLmh0bWwKLy8KLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIHFyY29kZQovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKLyoqCiAqIHFyY29kZQogKiBAcGFyYW0gdHlwZU51bWJlciAxIHRvIDQwCiAqIEBwYXJhbSBlcnJvckNvcnJlY3Rpb25MZXZlbCAnTCcsJ00nLCdRJywnSCcKICovCmV4cG9ydCBjb25zdCBxcmNvZGUgPSBmdW5jdGlvbih0eXBlTnVtYmVyLCBlcnJvckNvcnJlY3Rpb25MZXZlbCkgewoKICBjb25zdCBQQUQwID0gMHhFQzsKICBjb25zdCBQQUQxID0gMHgxMTsKCiAgbGV0IF90eXBlTnVtYmVyID0gdHlwZU51bWJlcjsKICBjb25zdCBfZXJyb3JDb3JyZWN0aW9uTGV2ZWwgPSBRUkVycm9yQ29ycmVjdGlvbkxldmVsW2Vycm9yQ29ycmVjdGlvbkxldmVsXTsKICBsZXQgX21vZHVsZXMgPSBudWxsOwogIGxldCBfbW9kdWxlQ291bnQgPSAwOwogIGxldCBfZGF0YUNhY2hlID0gbnVsbDsKICBjb25zdCBfZGF0YUxpc3QgPSBbXTsKCiAgY29uc3QgX3RoaXMgPSB7fTsKCiAgY29uc3QgbWFrZUltcGwgPSBmdW5jdGlvbih0ZXN0LCBtYXNrUGF0dGVybikgewoKICAgIF9tb2R1bGVDb3VudCA9IF90eXBlTnVtYmVyICogNCArIDE3OwogICAgX21vZHVsZXMgPSBmdW5jdGlvbihtb2R1bGVDb3VudCkgewogICAgICBjb25zdCBtb2R1bGVzID0gbmV3IEFycmF5KG1vZHVsZUNvdW50KTsKICAgICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgbW9kdWxlQ291bnQ7IHJvdyArPSAxKSB7CiAgICAgICAgbW9kdWxlc1tyb3ddID0gbmV3IEFycmF5KG1vZHVsZUNvdW50KTsKICAgICAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCBtb2R1bGVDb3VudDsgY29sICs9IDEpIHsKICAgICAgICAgIG1vZHVsZXNbcm93XVtjb2xdID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1vZHVsZXM7CiAgICB9KF9tb2R1bGVDb3VudCk7CgogICAgc2V0dXBQb3NpdGlvblByb2JlUGF0dGVybigwLCAwKTsKICAgIHNldHVwUG9zaXRpb25Qcm9iZVBhdHRlcm4oX21vZHVsZUNvdW50IC0gNywgMCk7CiAgICBzZXR1cFBvc2l0aW9uUHJvYmVQYXR0ZXJuKDAsIF9tb2R1bGVDb3VudCAtIDcpOwogICAgc2V0dXBQb3NpdGlvbkFkanVzdFBhdHRlcm4oKTsKICAgIHNldHVwVGltaW5nUGF0dGVybigpOwogICAgc2V0dXBUeXBlSW5mbyh0ZXN0LCBtYXNrUGF0dGVybik7CgogICAgaWYgKF90eXBlTnVtYmVyID49IDcpIHsKICAgICAgc2V0dXBUeXBlTnVtYmVyKHRlc3QpOwogICAgfQoKICAgIGlmIChfZGF0YUNhY2hlID09IG51bGwpIHsKICAgICAgX2RhdGFDYWNoZSA9IGNyZWF0ZURhdGEoX3R5cGVOdW1iZXIsIF9lcnJvckNvcnJlY3Rpb25MZXZlbCwgX2RhdGFMaXN0KTsKICAgIH0KCiAgICBtYXBEYXRhKF9kYXRhQ2FjaGUsIG1hc2tQYXR0ZXJuKTsKICB9OwoKICBjb25zdCBzZXR1cFBvc2l0aW9uUHJvYmVQYXR0ZXJuID0gZnVuY3Rpb24ocm93LCBjb2wpIHsKCiAgICBmb3IgKGxldCByID0gLTE7IHIgPD0gNzsgciArPSAxKSB7CgogICAgICBpZiAocm93ICsgciA8PSAtMSB8fCBfbW9kdWxlQ291bnQgPD0gcm93ICsgcikgY29udGludWU7CgogICAgICBmb3IgKGxldCBjID0gLTE7IGMgPD0gNzsgYyArPSAxKSB7CgogICAgICAgIGlmIChjb2wgKyBjIDw9IC0xIHx8IF9tb2R1bGVDb3VudCA8PSBjb2wgKyBjKSBjb250aW51ZTsKCiAgICAgICAgaWYgKCAoMCA8PSByICYmIHIgPD0gNiAmJiAoYyA9PSAwIHx8IGMgPT0gNikgKQogICAgICAgICAgICB8fCAoMCA8PSBjICYmIGMgPD0gNiAmJiAociA9PSAwIHx8IHIgPT0gNikgKQogICAgICAgICAgICB8fCAoMiA8PSByICYmIHIgPD0gNCAmJiAyIDw9IGMgJiYgYyA8PSA0KSApIHsKICAgICAgICAgIF9tb2R1bGVzW3JvdyArIHJdW2NvbCArIGNdID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX21vZHVsZXNbcm93ICsgcl1bY29sICsgY10gPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICBjb25zdCBnZXRCZXN0TWFza1BhdHRlcm4gPSBmdW5jdGlvbigpIHsKCiAgICBsZXQgbWluTG9zdFBvaW50ID0gMDsKICAgIGxldCBwYXR0ZXJuID0gMDsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7IGkgKz0gMSkgewoKICAgICAgbWFrZUltcGwodHJ1ZSwgaSk7CgogICAgICBjb25zdCBsb3N0UG9pbnQgPSBRUlV0aWwuZ2V0TG9zdFBvaW50KF90aGlzKTsKCiAgICAgIGlmIChpID09IDAgfHwgbWluTG9zdFBvaW50ID4gbG9zdFBvaW50KSB7CiAgICAgICAgbWluTG9zdFBvaW50ID0gbG9zdFBvaW50OwogICAgICAgIHBhdHRlcm4gPSBpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHBhdHRlcm47CiAgfTsKCiAgY29uc3Qgc2V0dXBUaW1pbmdQYXR0ZXJuID0gZnVuY3Rpb24oKSB7CgogICAgZm9yIChsZXQgciA9IDg7IHIgPCBfbW9kdWxlQ291bnQgLSA4OyByICs9IDEpIHsKICAgICAgaWYgKF9tb2R1bGVzW3JdWzZdICE9IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBfbW9kdWxlc1tyXVs2XSA9IChyICUgMiA9PSAwKTsKICAgIH0KCiAgICBmb3IgKGxldCBjID0gODsgYyA8IF9tb2R1bGVDb3VudCAtIDg7IGMgKz0gMSkgewogICAgICBpZiAoX21vZHVsZXNbNl1bY10gIT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIF9tb2R1bGVzWzZdW2NdID0gKGMgJSAyID09IDApOwogICAgfQogIH07CgogIGNvbnN0IHNldHVwUG9zaXRpb25BZGp1c3RQYXR0ZXJuID0gZnVuY3Rpb24oKSB7CgogICAgY29uc3QgcG9zID0gUVJVdGlsLmdldFBhdHRlcm5Qb3NpdGlvbihfdHlwZU51bWJlcik7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3MubGVuZ3RoOyBpICs9IDEpIHsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcG9zLmxlbmd0aDsgaiArPSAxKSB7CgogICAgICAgIGNvbnN0IHJvdyA9IHBvc1tpXTsKICAgICAgICBjb25zdCBjb2wgPSBwb3Nbal07CgogICAgICAgIGlmIChfbW9kdWxlc1tyb3ddW2NvbF0gIT0gbnVsbCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGxldCByID0gLTI7IHIgPD0gMjsgciArPSAxKSB7CgogICAgICAgICAgZm9yIChsZXQgYyA9IC0yOyBjIDw9IDI7IGMgKz0gMSkgewoKICAgICAgICAgICAgaWYgKHIgPT0gLTIgfHwgciA9PSAyIHx8IGMgPT0gLTIgfHwgYyA9PSAyCiAgICAgICAgICAgICAgICB8fCAociA9PSAwICYmIGMgPT0gMCkgKSB7CiAgICAgICAgICAgICAgX21vZHVsZXNbcm93ICsgcl1bY29sICsgY10gPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9tb2R1bGVzW3JvdyArIHJdW2NvbCArIGNdID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICBjb25zdCBzZXR1cFR5cGVOdW1iZXIgPSBmdW5jdGlvbih0ZXN0KSB7CgogICAgY29uc3QgYml0cyA9IFFSVXRpbC5nZXRCQ0hUeXBlTnVtYmVyKF90eXBlTnVtYmVyKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE4OyBpICs9IDEpIHsKICAgICAgY29uc3QgbW9kID0gKCF0ZXN0ICYmICggKGJpdHMgPj4gaSkgJiAxKSA9PSAxKTsKICAgICAgX21vZHVsZXNbTWF0aC5mbG9vcihpIC8gMyldW2kgJSAzICsgX21vZHVsZUNvdW50IC0gOCAtIDNdID0gbW9kOwogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTg7IGkgKz0gMSkgewogICAgICBjb25zdCBtb2QgPSAoIXRlc3QgJiYgKCAoYml0cyA+PiBpKSAmIDEpID09IDEpOwogICAgICBfbW9kdWxlc1tpICUgMyArIF9tb2R1bGVDb3VudCAtIDggLSAzXVtNYXRoLmZsb29yKGkgLyAzKV0gPSBtb2Q7CiAgICB9CiAgfTsKCiAgY29uc3Qgc2V0dXBUeXBlSW5mbyA9IGZ1bmN0aW9uKHRlc3QsIG1hc2tQYXR0ZXJuKSB7CgogICAgY29uc3QgZGF0YSA9IChfZXJyb3JDb3JyZWN0aW9uTGV2ZWwgPDwgMykgfCBtYXNrUGF0dGVybjsKICAgIGNvbnN0IGJpdHMgPSBRUlV0aWwuZ2V0QkNIVHlwZUluZm8oZGF0YSk7CgogICAgLy8gdmVydGljYWwKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTU7IGkgKz0gMSkgewoKICAgICAgY29uc3QgbW9kID0gKCF0ZXN0ICYmICggKGJpdHMgPj4gaSkgJiAxKSA9PSAxKTsKCiAgICAgIGlmIChpIDwgNikgewogICAgICAgIF9tb2R1bGVzW2ldWzhdID0gbW9kOwogICAgICB9IGVsc2UgaWYgKGkgPCA4KSB7CiAgICAgICAgX21vZHVsZXNbaSArIDFdWzhdID0gbW9kOwogICAgICB9IGVsc2UgewogICAgICAgIF9tb2R1bGVzW19tb2R1bGVDb3VudCAtIDE1ICsgaV1bOF0gPSBtb2Q7CiAgICAgIH0KICAgIH0KCiAgICAvLyBob3Jpem9udGFsCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE1OyBpICs9IDEpIHsKCiAgICAgIGNvbnN0IG1vZCA9ICghdGVzdCAmJiAoIChiaXRzID4+IGkpICYgMSkgPT0gMSk7CgogICAgICBpZiAoaSA8IDgpIHsKICAgICAgICBfbW9kdWxlc1s4XVtfbW9kdWxlQ291bnQgLSBpIC0gMV0gPSBtb2Q7CiAgICAgIH0gZWxzZSBpZiAoaSA8IDkpIHsKICAgICAgICBfbW9kdWxlc1s4XVsxNSAtIGkgLSAxICsgMV0gPSBtb2Q7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX21vZHVsZXNbOF1bMTUgLSBpIC0gMV0gPSBtb2Q7CiAgICAgIH0KICAgIH0KCiAgICAvLyBmaXhlZCBtb2R1bGUKICAgIF9tb2R1bGVzW19tb2R1bGVDb3VudCAtIDhdWzhdID0gKCF0ZXN0KTsKICB9OwoKICBjb25zdCBtYXBEYXRhID0gZnVuY3Rpb24oZGF0YSwgbWFza1BhdHRlcm4pIHsKCiAgICBsZXQgaW5jID0gLTE7CiAgICBsZXQgcm93ID0gX21vZHVsZUNvdW50IC0gMTsKICAgIGxldCBiaXRJbmRleCA9IDc7CiAgICBsZXQgYnl0ZUluZGV4ID0gMDsKICAgIGNvbnN0IG1hc2tGdW5jID0gUVJVdGlsLmdldE1hc2tGdW5jdGlvbihtYXNrUGF0dGVybik7CgogICAgZm9yIChsZXQgY29sID0gX21vZHVsZUNvdW50IC0gMTsgY29sID4gMDsgY29sIC09IDIpIHsKCiAgICAgIGlmIChjb2wgPT0gNikgY29sIC09IDE7CgogICAgICB3aGlsZSAodHJ1ZSkgewoKICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IDI7IGMgKz0gMSkgewoKICAgICAgICAgIGlmIChfbW9kdWxlc1tyb3ddW2NvbCAtIGNdID09IG51bGwpIHsKCiAgICAgICAgICAgIGxldCBkYXJrID0gZmFsc2U7CgogICAgICAgICAgICBpZiAoYnl0ZUluZGV4IDwgZGF0YS5sZW5ndGgpIHsKICAgICAgICAgICAgICBkYXJrID0gKCAoIChkYXRhW2J5dGVJbmRleF0gPj4+IGJpdEluZGV4KSAmIDEpID09IDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBtYXNrID0gbWFza0Z1bmMocm93LCBjb2wgLSBjKTsKCiAgICAgICAgICAgIGlmIChtYXNrKSB7CiAgICAgICAgICAgICAgZGFyayA9ICFkYXJrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfbW9kdWxlc1tyb3ddW2NvbCAtIGNdID0gZGFyazsKICAgICAgICAgICAgYml0SW5kZXggLT0gMTsKCiAgICAgICAgICAgIGlmIChiaXRJbmRleCA9PSAtMSkgewogICAgICAgICAgICAgIGJ5dGVJbmRleCArPSAxOwogICAgICAgICAgICAgIGJpdEluZGV4ID0gNzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcm93ICs9IGluYzsKCiAgICAgICAgaWYgKHJvdyA8IDAgfHwgX21vZHVsZUNvdW50IDw9IHJvdykgewogICAgICAgICAgcm93IC09IGluYzsKICAgICAgICAgIGluYyA9IC1pbmM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICBjb25zdCBjcmVhdGVCeXRlcyA9IGZ1bmN0aW9uKGJ1ZmZlciwgcnNCbG9ja3MpIHsKCiAgICBsZXQgb2Zmc2V0ID0gMDsKCiAgICBsZXQgbWF4RGNDb3VudCA9IDA7CiAgICBsZXQgbWF4RWNDb3VudCA9IDA7CgogICAgY29uc3QgZGNkYXRhID0gbmV3IEFycmF5KHJzQmxvY2tzLmxlbmd0aCk7CiAgICBjb25zdCBlY2RhdGEgPSBuZXcgQXJyYXkocnNCbG9ja3MubGVuZ3RoKTsKCiAgICBmb3IgKGxldCByID0gMDsgciA8IHJzQmxvY2tzLmxlbmd0aDsgciArPSAxKSB7CgogICAgICBjb25zdCBkY0NvdW50ID0gcnNCbG9ja3Nbcl0uZGF0YUNvdW50OwogICAgICBjb25zdCBlY0NvdW50ID0gcnNCbG9ja3Nbcl0udG90YWxDb3VudCAtIGRjQ291bnQ7CgogICAgICBtYXhEY0NvdW50ID0gTWF0aC5tYXgobWF4RGNDb3VudCwgZGNDb3VudCk7CiAgICAgIG1heEVjQ291bnQgPSBNYXRoLm1heChtYXhFY0NvdW50LCBlY0NvdW50KTsKCiAgICAgIGRjZGF0YVtyXSA9IG5ldyBBcnJheShkY0NvdW50KTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGNkYXRhW3JdLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgZGNkYXRhW3JdW2ldID0gMHhmZiAmIGJ1ZmZlci5nZXRCdWZmZXIoKVtpICsgb2Zmc2V0XTsKICAgICAgfQogICAgICBvZmZzZXQgKz0gZGNDb3VudDsKCiAgICAgIGNvbnN0IHJzUG9seSA9IFFSVXRpbC5nZXRFcnJvckNvcnJlY3RQb2x5bm9taWFsKGVjQ291bnQpOwogICAgICBjb25zdCByYXdQb2x5ID0gcXJQb2x5bm9taWFsKGRjZGF0YVtyXSwgcnNQb2x5LmdldExlbmd0aCgpIC0gMSk7CgogICAgICBjb25zdCBtb2RQb2x5ID0gcmF3UG9seS5tb2QocnNQb2x5KTsKICAgICAgZWNkYXRhW3JdID0gbmV3IEFycmF5KHJzUG9seS5nZXRMZW5ndGgoKSAtIDEpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVjZGF0YVtyXS5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgIGNvbnN0IG1vZEluZGV4ID0gaSArIG1vZFBvbHkuZ2V0TGVuZ3RoKCkgLSBlY2RhdGFbcl0ubGVuZ3RoOwogICAgICAgIGVjZGF0YVtyXVtpXSA9IChtb2RJbmRleCA+PSAwKT8gbW9kUG9seS5nZXRBdChtb2RJbmRleCkgOiAwOwogICAgICB9CiAgICB9CgogICAgbGV0IHRvdGFsQ29kZUNvdW50ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcnNCbG9ja3MubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgdG90YWxDb2RlQ291bnQgKz0gcnNCbG9ja3NbaV0udG90YWxDb3VudDsKICAgIH0KCiAgICBjb25zdCBkYXRhID0gbmV3IEFycmF5KHRvdGFsQ29kZUNvdW50KTsKICAgIGxldCBpbmRleCA9IDA7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhEY0NvdW50OyBpICs9IDEpIHsKICAgICAgZm9yIChsZXQgciA9IDA7IHIgPCByc0Jsb2Nrcy5sZW5ndGg7IHIgKz0gMSkgewogICAgICAgIGlmIChpIDwgZGNkYXRhW3JdLmxlbmd0aCkgewogICAgICAgICAgZGF0YVtpbmRleF0gPSBkY2RhdGFbcl1baV07CiAgICAgICAgICBpbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4RWNDb3VudDsgaSArPSAxKSB7CiAgICAgIGZvciAobGV0IHIgPSAwOyByIDwgcnNCbG9ja3MubGVuZ3RoOyByICs9IDEpIHsKICAgICAgICBpZiAoaSA8IGVjZGF0YVtyXS5sZW5ndGgpIHsKICAgICAgICAgIGRhdGFbaW5kZXhdID0gZWNkYXRhW3JdW2ldOwogICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZGF0YTsKICB9OwoKICBjb25zdCBjcmVhdGVEYXRhID0gZnVuY3Rpb24odHlwZU51bWJlciwgZXJyb3JDb3JyZWN0aW9uTGV2ZWwsIGRhdGFMaXN0KSB7CgogICAgY29uc3QgcnNCbG9ja3MgPSBRUlJTQmxvY2suZ2V0UlNCbG9ja3ModHlwZU51bWJlciwgZXJyb3JDb3JyZWN0aW9uTGV2ZWwpOwoKICAgIGNvbnN0IGJ1ZmZlciA9IHFyQml0QnVmZmVyKCk7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhTGlzdC5sZW5ndGg7IGkgKz0gMSkgewogICAgICBjb25zdCBkYXRhID0gZGF0YUxpc3RbaV07CiAgICAgIGJ1ZmZlci5wdXQoZGF0YS5nZXRNb2RlKCksIDQpOwogICAgICBidWZmZXIucHV0KGRhdGEuZ2V0TGVuZ3RoKCksIFFSVXRpbC5nZXRMZW5ndGhJbkJpdHMoZGF0YS5nZXRNb2RlKCksIHR5cGVOdW1iZXIpICk7CiAgICAgIGRhdGEud3JpdGUoYnVmZmVyKTsKICAgIH0KCiAgICAvLyBjYWxjIG51bSBtYXggZGF0YS4KICAgIGxldCB0b3RhbERhdGFDb3VudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJzQmxvY2tzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgIHRvdGFsRGF0YUNvdW50ICs9IHJzQmxvY2tzW2ldLmRhdGFDb3VudDsKICAgIH0KCiAgICBpZiAoYnVmZmVyLmdldExlbmd0aEluQml0cygpID4gdG90YWxEYXRhQ291bnQgKiA4KSB7CiAgICAgIHRocm93ICdjb2RlIGxlbmd0aCBvdmVyZmxvdy4gKCcKICAgICAgICArIGJ1ZmZlci5nZXRMZW5ndGhJbkJpdHMoKQogICAgICAgICsgJz4nCiAgICAgICAgKyB0b3RhbERhdGFDb3VudCAqIDgKICAgICAgICArICcpJzsKICAgIH0KCiAgICAvLyBlbmQgY29kZQogICAgaWYgKGJ1ZmZlci5nZXRMZW5ndGhJbkJpdHMoKSArIDQgPD0gdG90YWxEYXRhQ291bnQgKiA4KSB7CiAgICAgIGJ1ZmZlci5wdXQoMCwgNCk7CiAgICB9CgogICAgLy8gcGFkZGluZwogICAgd2hpbGUgKGJ1ZmZlci5nZXRMZW5ndGhJbkJpdHMoKSAlIDggIT0gMCkgewogICAgICBidWZmZXIucHV0Qml0KGZhbHNlKTsKICAgIH0KCiAgICAvLyBwYWRkaW5nCiAgICB3aGlsZSAodHJ1ZSkgewoKICAgICAgaWYgKGJ1ZmZlci5nZXRMZW5ndGhJbkJpdHMoKSA+PSB0b3RhbERhdGFDb3VudCAqIDgpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBidWZmZXIucHV0KFBBRDAsIDgpOwoKICAgICAgaWYgKGJ1ZmZlci5nZXRMZW5ndGhJbkJpdHMoKSA+PSB0b3RhbERhdGFDb3VudCAqIDgpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBidWZmZXIucHV0KFBBRDEsIDgpOwogICAgfQoKICAgIHJldHVybiBjcmVhdGVCeXRlcyhidWZmZXIsIHJzQmxvY2tzKTsKICB9OwoKICBfdGhpcy5hZGREYXRhID0gZnVuY3Rpb24oZGF0YSwgbW9kZSkgewoKICAgIG1vZGUgPSBtb2RlIHx8ICdCeXRlJzsKCiAgICBsZXQgbmV3RGF0YSA9IG51bGw7CgogICAgc3dpdGNoKG1vZGUpIHsKICAgIGNhc2UgJ051bWVyaWMnIDoKICAgICAgbmV3RGF0YSA9IHFyTnVtYmVyKGRhdGEpOwogICAgICBicmVhazsKICAgIGNhc2UgJ0FscGhhbnVtZXJpYycgOgogICAgICBuZXdEYXRhID0gcXJBbHBoYU51bShkYXRhKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdCeXRlJyA6CiAgICAgIG5ld0RhdGEgPSBxcjhCaXRCeXRlKGRhdGEpOwogICAgICBicmVhazsKICAgIGNhc2UgJ0thbmppJyA6CiAgICAgIG5ld0RhdGEgPSBxckthbmppKGRhdGEpOwogICAgICBicmVhazsKICAgIGRlZmF1bHQgOgogICAgICB0aHJvdyAnbW9kZTonICsgbW9kZTsKICAgIH0KCiAgICBfZGF0YUxpc3QucHVzaChuZXdEYXRhKTsKICAgIF9kYXRhQ2FjaGUgPSBudWxsOwogIH07CgogIF90aGlzLmlzRGFyayA9IGZ1bmN0aW9uKHJvdywgY29sKSB7CiAgICBpZiAocm93IDwgMCB8fCBfbW9kdWxlQ291bnQgPD0gcm93IHx8IGNvbCA8IDAgfHwgX21vZHVsZUNvdW50IDw9IGNvbCkgewogICAgICB0aHJvdyByb3cgKyAnLCcgKyBjb2w7CiAgICB9CiAgICByZXR1cm4gX21vZHVsZXNbcm93XVtjb2xdOwogIH07CgogIF90aGlzLmdldE1vZHVsZUNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gX21vZHVsZUNvdW50OwogIH07CgogIF90aGlzLm1ha2UgPSBmdW5jdGlvbigpIHsKICAgIGlmIChfdHlwZU51bWJlciA8IDEpIHsKICAgICAgbGV0IHR5cGVOdW1iZXIgPSAxOwoKICAgICAgZm9yICg7IHR5cGVOdW1iZXIgPCA0MDsgdHlwZU51bWJlcisrKSB7CiAgICAgICAgY29uc3QgcnNCbG9ja3MgPSBRUlJTQmxvY2suZ2V0UlNCbG9ja3ModHlwZU51bWJlciwgX2Vycm9yQ29ycmVjdGlvbkxldmVsKTsKICAgICAgICBjb25zdCBidWZmZXIgPSBxckJpdEJ1ZmZlcigpOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IF9kYXRhTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZGF0YSA9IF9kYXRhTGlzdFtpXTsKICAgICAgICAgIGJ1ZmZlci5wdXQoZGF0YS5nZXRNb2RlKCksIDQpOwogICAgICAgICAgYnVmZmVyLnB1dChkYXRhLmdldExlbmd0aCgpLCBRUlV0aWwuZ2V0TGVuZ3RoSW5CaXRzKGRhdGEuZ2V0TW9kZSgpLCB0eXBlTnVtYmVyKSApOwogICAgICAgICAgZGF0YS53cml0ZShidWZmZXIpOwogICAgICAgIH0KCiAgICAgICAgbGV0IHRvdGFsRGF0YUNvdW50ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJzQmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0b3RhbERhdGFDb3VudCArPSByc0Jsb2Nrc1tpXS5kYXRhQ291bnQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoYnVmZmVyLmdldExlbmd0aEluQml0cygpIDw9IHRvdGFsRGF0YUNvdW50ICogOCkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBfdHlwZU51bWJlciA9IHR5cGVOdW1iZXI7CiAgICB9CgogICAgbWFrZUltcGwoZmFsc2UsIGdldEJlc3RNYXNrUGF0dGVybigpICk7CiAgfTsKCiAgX3RoaXMuY3JlYXRlVGFibGVUYWcgPSBmdW5jdGlvbihjZWxsU2l6ZSwgbWFyZ2luKSB7CgogICAgY2VsbFNpemUgPSBjZWxsU2l6ZSB8fCAyOwogICAgbWFyZ2luID0gKHR5cGVvZiBtYXJnaW4gPT0gJ3VuZGVmaW5lZCcpPyBjZWxsU2l6ZSAqIDQgOiBtYXJnaW47CgogICAgbGV0IHFySHRtbCA9ICcnOwoKICAgIHFySHRtbCArPSAnPHRhYmxlIHN0eWxlPSInOwogICAgcXJIdG1sICs9ICcgYm9yZGVyLXdpZHRoOiAwcHg7IGJvcmRlci1zdHlsZTogbm9uZTsnOwogICAgcXJIdG1sICs9ICcgYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsnOwogICAgcXJIdG1sICs9ICcgcGFkZGluZzogMHB4OyBtYXJnaW46ICcgKyBtYXJnaW4gKyAncHg7JzsKICAgIHFySHRtbCArPSAnIj4nOwogICAgcXJIdG1sICs9ICc8dGJvZHk+JzsKCiAgICBmb3IgKGxldCByID0gMDsgciA8IF90aGlzLmdldE1vZHVsZUNvdW50KCk7IHIgKz0gMSkgewoKICAgICAgcXJIdG1sICs9ICc8dHI+JzsKCiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgX3RoaXMuZ2V0TW9kdWxlQ291bnQoKTsgYyArPSAxKSB7CiAgICAgICAgcXJIdG1sICs9ICc8dGQgc3R5bGU9Iic7CiAgICAgICAgcXJIdG1sICs9ICcgYm9yZGVyLXdpZHRoOiAwcHg7IGJvcmRlci1zdHlsZTogbm9uZTsnOwogICAgICAgIHFySHRtbCArPSAnIGJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7JzsKICAgICAgICBxckh0bWwgKz0gJyBwYWRkaW5nOiAwcHg7IG1hcmdpbjogMHB4Oyc7CiAgICAgICAgcXJIdG1sICs9ICcgd2lkdGg6ICcgKyBjZWxsU2l6ZSArICdweDsnOwogICAgICAgIHFySHRtbCArPSAnIGhlaWdodDogJyArIGNlbGxTaXplICsgJ3B4Oyc7CiAgICAgICAgcXJIdG1sICs9ICcgYmFja2dyb3VuZC1jb2xvcjogJzsKICAgICAgICBxckh0bWwgKz0gX3RoaXMuaXNEYXJrKHIsIGMpPyAnIzAwMDAwMCcgOiAnI2ZmZmZmZic7CiAgICAgICAgcXJIdG1sICs9ICc7JzsKICAgICAgICBxckh0bWwgKz0gJyIvPic7CiAgICAgIH0KCiAgICAgIHFySHRtbCArPSAnPC90cj4nOwogICAgfQoKICAgIHFySHRtbCArPSAnPC90Ym9keT4nOwogICAgcXJIdG1sICs9ICc8L3RhYmxlPic7CgogICAgcmV0dXJuIHFySHRtbDsKICB9OwoKICBfdGhpcy5jcmVhdGVTdmdUYWcgPSBmdW5jdGlvbihjZWxsU2l6ZSwgbWFyZ2luLCBhbHQsIHRpdGxlKSB7CgogICAgbGV0IG9wdHMgPSB7fTsKICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09ICdvYmplY3QnKSB7CiAgICAgIC8vIENhbGxlZCBieSBvcHRpb25zLgogICAgICBvcHRzID0gYXJndW1lbnRzWzBdOwogICAgICAvLyBvdmVyd3JpdGUgY2VsbFNpemUgYW5kIG1hcmdpbi4KICAgICAgY2VsbFNpemUgPSBvcHRzLmNlbGxTaXplOwogICAgICBtYXJnaW4gPSBvcHRzLm1hcmdpbjsKICAgICAgYWx0ID0gb3B0cy5hbHQ7CiAgICAgIHRpdGxlID0gb3B0cy50aXRsZTsKICAgIH0KCiAgICBjZWxsU2l6ZSA9IGNlbGxTaXplIHx8IDI7CiAgICBtYXJnaW4gPSAodHlwZW9mIG1hcmdpbiA9PSAndW5kZWZpbmVkJyk/IGNlbGxTaXplICogNCA6IG1hcmdpbjsKCiAgICAvLyBDb21wb3NlIGFsdCBwcm9wZXJ0eSBzdXJyb2dhdGUKICAgIGFsdCA9ICh0eXBlb2YgYWx0ID09PSAnc3RyaW5nJykgPyB7dGV4dDogYWx0fSA6IGFsdCB8fCB7fTsKICAgIGFsdC50ZXh0ID0gYWx0LnRleHQgfHwgbnVsbDsKICAgIGFsdC5pZCA9IChhbHQudGV4dCkgPyBhbHQuaWQgfHwgJ3FyY29kZS1kZXNjcmlwdGlvbicgOiBudWxsOwoKICAgIC8vIENvbXBvc2UgdGl0bGUgcHJvcGVydHkgc3Vycm9nYXRlCiAgICB0aXRsZSA9ICh0eXBlb2YgdGl0bGUgPT09ICdzdHJpbmcnKSA/IHt0ZXh0OiB0aXRsZX0gOiB0aXRsZSB8fCB7fTsKICAgIHRpdGxlLnRleHQgPSB0aXRsZS50ZXh0IHx8IG51bGw7CiAgICB0aXRsZS5pZCA9ICh0aXRsZS50ZXh0KSA/IHRpdGxlLmlkIHx8ICdxcmNvZGUtdGl0bGUnIDogbnVsbDsKCiAgICBjb25zdCBzaXplID0gX3RoaXMuZ2V0TW9kdWxlQ291bnQoKSAqIGNlbGxTaXplICsgbWFyZ2luICogMjsKICAgIGxldCBjLCBtYywgciwgbXIsIHFyU3ZnPScnLCByZWN0OwoKICAgIHJlY3QgPSAnbCcgKyBjZWxsU2l6ZSArICcsMCAwLCcgKyBjZWxsU2l6ZSArCiAgICAgICcgLScgKyBjZWxsU2l6ZSArICcsMCAwLC0nICsgY2VsbFNpemUgKyAneiAnOwoKICAgIHFyU3ZnICs9ICc8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIic7CiAgICBxclN2ZyArPSAhb3B0cy5zY2FsYWJsZSA/ICcgd2lkdGg9IicgKyBzaXplICsgJ3B4IiBoZWlnaHQ9IicgKyBzaXplICsgJ3B4IicgOiAnJzsKICAgIHFyU3ZnICs9ICcgdmlld0JveD0iMCAwICcgKyBzaXplICsgJyAnICsgc2l6ZSArICciICc7CiAgICBxclN2ZyArPSAnIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaW5ZTWluIG1lZXQiJzsKICAgIHFyU3ZnICs9ICh0aXRsZS50ZXh0IHx8IGFsdC50ZXh0KSA/ICcgcm9sZT0iaW1nIiBhcmlhLWxhYmVsbGVkYnk9IicgKwogICAgICAgIGVzY2FwZVhtbChbdGl0bGUuaWQsIGFsdC5pZF0uam9pbignICcpLnRyaW0oKSApICsgJyInIDogJyc7CiAgICBxclN2ZyArPSAnPic7CiAgICBxclN2ZyArPSAodGl0bGUudGV4dCkgPyAnPHRpdGxlIGlkPSInICsgZXNjYXBlWG1sKHRpdGxlLmlkKSArICciPicgKwogICAgICAgIGVzY2FwZVhtbCh0aXRsZS50ZXh0KSArICc8L3RpdGxlPicgOiAnJzsKICAgIHFyU3ZnICs9IChhbHQudGV4dCkgPyAnPGRlc2NyaXB0aW9uIGlkPSInICsgZXNjYXBlWG1sKGFsdC5pZCkgKyAnIj4nICsKICAgICAgICBlc2NhcGVYbWwoYWx0LnRleHQpICsgJzwvZGVzY3JpcHRpb24+JyA6ICcnOwogICAgcXJTdmcgKz0gJzxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IndoaXRlIiBjeD0iMCIgY3k9IjAiLz4nOwogICAgcXJTdmcgKz0gJzxwYXRoIGQ9Iic7CgogICAgZm9yIChyID0gMDsgciA8IF90aGlzLmdldE1vZHVsZUNvdW50KCk7IHIgKz0gMSkgewogICAgICBtciA9IHIgKiBjZWxsU2l6ZSArIG1hcmdpbjsKICAgICAgZm9yIChjID0gMDsgYyA8IF90aGlzLmdldE1vZHVsZUNvdW50KCk7IGMgKz0gMSkgewogICAgICAgIGlmIChfdGhpcy5pc0RhcmsociwgYykgKSB7CiAgICAgICAgICBtYyA9IGMqY2VsbFNpemUrbWFyZ2luOwogICAgICAgICAgcXJTdmcgKz0gJ00nICsgbWMgKyAnLCcgKyBtciArIHJlY3Q7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcXJTdmcgKz0gJyIgc3Ryb2tlPSJ0cmFuc3BhcmVudCIgZmlsbD0iYmxhY2siLz4nOwogICAgcXJTdmcgKz0gJzwvc3ZnPic7CgogICAgcmV0dXJuIHFyU3ZnOwogIH07CgogIF90aGlzLmNyZWF0ZURhdGFVUkwgPSBmdW5jdGlvbihjZWxsU2l6ZSwgbWFyZ2luKSB7CgogICAgY2VsbFNpemUgPSBjZWxsU2l6ZSB8fCAyOwogICAgbWFyZ2luID0gKHR5cGVvZiBtYXJnaW4gPT0gJ3VuZGVmaW5lZCcpPyBjZWxsU2l6ZSAqIDQgOiBtYXJnaW47CgogICAgY29uc3Qgc2l6ZSA9IF90aGlzLmdldE1vZHVsZUNvdW50KCkgKiBjZWxsU2l6ZSArIG1hcmdpbiAqIDI7CiAgICBjb25zdCBtaW4gPSBtYXJnaW47CiAgICBjb25zdCBtYXggPSBzaXplIC0gbWFyZ2luOwoKICAgIHJldHVybiBjcmVhdGVEYXRhVVJMKHNpemUsIHNpemUsIGZ1bmN0aW9uKHgsIHkpIHsKICAgICAgaWYgKG1pbiA8PSB4ICYmIHggPCBtYXggJiYgbWluIDw9IHkgJiYgeSA8IG1heCkgewogICAgICAgIGNvbnN0IGMgPSBNYXRoLmZsb29yKCAoeCAtIG1pbikgLyBjZWxsU2l6ZSk7CiAgICAgICAgY29uc3QgciA9IE1hdGguZmxvb3IoICh5IC0gbWluKSAvIGNlbGxTaXplKTsKICAgICAgICByZXR1cm4gX3RoaXMuaXNEYXJrKHIsIGMpPyAwIDogMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgfSApOwogIH07CgogIF90aGlzLmNyZWF0ZUltZ1RhZyA9IGZ1bmN0aW9uKGNlbGxTaXplLCBtYXJnaW4sIGFsdCkgewoKICAgIGNlbGxTaXplID0gY2VsbFNpemUgfHwgMjsKICAgIG1hcmdpbiA9ICh0eXBlb2YgbWFyZ2luID09ICd1bmRlZmluZWQnKT8gY2VsbFNpemUgKiA0IDogbWFyZ2luOwoKICAgIGNvbnN0IHNpemUgPSBfdGhpcy5nZXRNb2R1bGVDb3VudCgpICogY2VsbFNpemUgKyBtYXJnaW4gKiAyOwoKICAgIGxldCBpbWcgPSAnJzsKICAgIGltZyArPSAnPGltZyc7CiAgICBpbWcgKz0gJ1x1MDAyMHNyYz0iJzsKICAgIGltZyArPSBfdGhpcy5jcmVhdGVEYXRhVVJMKGNlbGxTaXplLCBtYXJnaW4pOwogICAgaW1nICs9ICciJzsKICAgIGltZyArPSAnXHUwMDIwd2lkdGg9Iic7CiAgICBpbWcgKz0gc2l6ZTsKICAgIGltZyArPSAnIic7CiAgICBpbWcgKz0gJ1x1MDAyMGhlaWdodD0iJzsKICAgIGltZyArPSBzaXplOwogICAgaW1nICs9ICciJzsKICAgIGlmIChhbHQpIHsKICAgICAgaW1nICs9ICdcdTAwMjBhbHQ9Iic7CiAgICAgIGltZyArPSBlc2NhcGVYbWwoYWx0KTsKICAgICAgaW1nICs9ICciJzsKICAgIH0KICAgIGltZyArPSAnLz4nOwoKICAgIHJldHVybiBpbWc7CiAgfTsKCiAgY29uc3QgZXNjYXBlWG1sID0gZnVuY3Rpb24ocykgewogICAgbGV0IGVzY2FwZWQgPSAnJzsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkgKz0gMSkgewogICAgICBjb25zdCBjID0gcy5jaGFyQXQoaSk7CiAgICAgIHN3aXRjaChjKSB7CiAgICAgIGNhc2UgJzwnOiBlc2NhcGVkICs9ICcmbHQ7JzsgYnJlYWs7CiAgICAgIGNhc2UgJz4nOiBlc2NhcGVkICs9ICcmZ3Q7JzsgYnJlYWs7CiAgICAgIGNhc2UgJyYnOiBlc2NhcGVkICs9ICcmYW1wOyc7IGJyZWFrOwogICAgICBjYXNlICciJzogZXNjYXBlZCArPSAnJnF1b3Q7JzsgYnJlYWs7CiAgICAgIGRlZmF1bHQgOiBlc2NhcGVkICs9IGM7IGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZXNjYXBlZDsKICB9OwoKICBjb25zdCBfY3JlYXRlSGFsZkFTQ0lJID0gZnVuY3Rpb24obWFyZ2luKSB7CiAgICBjb25zdCBjZWxsU2l6ZSA9IDE7CiAgICBtYXJnaW4gPSAodHlwZW9mIG1hcmdpbiA9PSAndW5kZWZpbmVkJyk/IGNlbGxTaXplICogMiA6IG1hcmdpbjsKCiAgICBjb25zdCBzaXplID0gX3RoaXMuZ2V0TW9kdWxlQ291bnQoKSAqIGNlbGxTaXplICsgbWFyZ2luICogMjsKICAgIGNvbnN0IG1pbiA9IG1hcmdpbjsKICAgIGNvbnN0IG1heCA9IHNpemUgLSBtYXJnaW47CgogICAgbGV0IHksIHgsIHIxLCByMiwgcDsKCiAgICBjb25zdCBibG9ja3MgPSB7CiAgICAgICfilojilognOiAn4paIJywKICAgICAgJ+KWiCAnOiAn4paAJywKICAgICAgJyDilognOiAn4paEJywKICAgICAgJyAgJzogJyAnCiAgICB9OwoKICAgIGNvbnN0IGJsb2Nrc0xhc3RMaW5lTm9NYXJnaW4gPSB7CiAgICAgICfilojilognOiAn4paAJywKICAgICAgJ+KWiCAnOiAn4paAJywKICAgICAgJyDilognOiAnICcsCiAgICAgICcgICc6ICcgJwogICAgfTsKCiAgICBsZXQgYXNjaWkgPSAnJzsKICAgIGZvciAoeSA9IDA7IHkgPCBzaXplOyB5ICs9IDIpIHsKICAgICAgcjEgPSBNYXRoLmZsb29yKCh5IC0gbWluKSAvIGNlbGxTaXplKTsKICAgICAgcjIgPSBNYXRoLmZsb29yKCh5ICsgMSAtIG1pbikgLyBjZWxsU2l6ZSk7CiAgICAgIGZvciAoeCA9IDA7IHggPCBzaXplOyB4ICs9IDEpIHsKICAgICAgICBwID0gJ+KWiCc7CgogICAgICAgIGlmIChtaW4gPD0geCAmJiB4IDwgbWF4ICYmIG1pbiA8PSB5ICYmIHkgPCBtYXggJiYgX3RoaXMuaXNEYXJrKHIxLCBNYXRoLmZsb29yKCh4IC0gbWluKSAvIGNlbGxTaXplKSkpIHsKICAgICAgICAgIHAgPSAnICc7CiAgICAgICAgfQoKICAgICAgICBpZiAobWluIDw9IHggJiYgeCA8IG1heCAmJiBtaW4gPD0geSsxICYmIHkrMSA8IG1heCAmJiBfdGhpcy5pc0RhcmsocjIsIE1hdGguZmxvb3IoKHggLSBtaW4pIC8gY2VsbFNpemUpKSkgewogICAgICAgICAgcCArPSAnICc7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgcCArPSAn4paIJzsKICAgICAgICB9CgogICAgICAgIC8vIE91dHB1dCAyIGNoYXJhY3RlcnMgcGVyIHBpeGVsLCB0byBjcmVhdGUgZnVsbCBzcXVhcmUuIDEgY2hhcmFjdGVyIHBlciBwaXhlbHMgZ2l2ZXMgb25seSBoYWxmIHdpZHRoIG9mIHNxdWFyZS4KICAgICAgICBhc2NpaSArPSAobWFyZ2luIDwgMSAmJiB5KzEgPj0gbWF4KSA/IGJsb2Nrc0xhc3RMaW5lTm9NYXJnaW5bcF0gOiBibG9ja3NbcF07CiAgICAgIH0KCiAgICAgIGFzY2lpICs9ICdcbic7CiAgICB9CgogICAgaWYgKHNpemUgJSAyICYmIG1hcmdpbiA+IDApIHsKICAgICAgcmV0dXJuIGFzY2lpLnN1YnN0cmluZygwLCBhc2NpaS5sZW5ndGggLSBzaXplIC0gMSkgKyBBcnJheShzaXplKzEpLmpvaW4oJ+KWgCcpOwogICAgfQoKICAgIHJldHVybiBhc2NpaS5zdWJzdHJpbmcoMCwgYXNjaWkubGVuZ3RoLTEpOwogIH07CgogIF90aGlzLmNyZWF0ZUFTQ0lJID0gZnVuY3Rpb24oY2VsbFNpemUsIG1hcmdpbikgewogICAgY2VsbFNpemUgPSBjZWxsU2l6ZSB8fCAxOwoKICAgIGlmIChjZWxsU2l6ZSA8IDIpIHsKICAgICAgcmV0dXJuIF9jcmVhdGVIYWxmQVNDSUkobWFyZ2luKTsKICAgIH0KCiAgICBjZWxsU2l6ZSAtPSAxOwogICAgbWFyZ2luID0gKHR5cGVvZiBtYXJnaW4gPT0gJ3VuZGVmaW5lZCcpPyBjZWxsU2l6ZSAqIDIgOiBtYXJnaW47CgogICAgY29uc3Qgc2l6ZSA9IF90aGlzLmdldE1vZHVsZUNvdW50KCkgKiBjZWxsU2l6ZSArIG1hcmdpbiAqIDI7CiAgICBjb25zdCBtaW4gPSBtYXJnaW47CiAgICBjb25zdCBtYXggPSBzaXplIC0gbWFyZ2luOwoKICAgIGxldCB5LCB4LCByLCBwOwoKICAgIGNvbnN0IHdoaXRlID0gQXJyYXkoY2VsbFNpemUrMSkuam9pbign4paI4paIJyk7CiAgICBjb25zdCBibGFjayA9IEFycmF5KGNlbGxTaXplKzEpLmpvaW4oJyAgJyk7CgogICAgbGV0IGFzY2lpID0gJyc7CiAgICBsZXQgbGluZSA9ICcnOwogICAgZm9yICh5ID0gMDsgeSA8IHNpemU7IHkgKz0gMSkgewogICAgICByID0gTWF0aC5mbG9vciggKHkgLSBtaW4pIC8gY2VsbFNpemUpOwogICAgICBsaW5lID0gJyc7CiAgICAgIGZvciAoeCA9IDA7IHggPCBzaXplOyB4ICs9IDEpIHsKICAgICAgICBwID0gMTsKCiAgICAgICAgaWYgKG1pbiA8PSB4ICYmIHggPCBtYXggJiYgbWluIDw9IHkgJiYgeSA8IG1heCAmJiBfdGhpcy5pc0RhcmsociwgTWF0aC5mbG9vcigoeCAtIG1pbikgLyBjZWxsU2l6ZSkpKSB7CiAgICAgICAgICBwID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIE91dHB1dCAyIGNoYXJhY3RlcnMgcGVyIHBpeGVsLCB0byBjcmVhdGUgZnVsbCBzcXVhcmUuIDEgY2hhcmFjdGVyIHBlciBwaXhlbHMgZ2l2ZXMgb25seSBoYWxmIHdpZHRoIG9mIHNxdWFyZS4KICAgICAgICBsaW5lICs9IHAgPyB3aGl0ZSA6IGJsYWNrOwogICAgICB9CgogICAgICBmb3IgKHIgPSAwOyByIDwgY2VsbFNpemU7IHIgKz0gMSkgewogICAgICAgIGFzY2lpICs9IGxpbmUgKyAnXG4nOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGFzY2lpLnN1YnN0cmluZygwLCBhc2NpaS5sZW5ndGgtMSk7CiAgfTsKCiAgX3RoaXMucmVuZGVyVG8yZENvbnRleHQgPSBmdW5jdGlvbihjb250ZXh0LCBjZWxsU2l6ZSkgewogICAgY2VsbFNpemUgPSBjZWxsU2l6ZSB8fCAyOwogICAgY29uc3QgbGVuZ3RoID0gX3RoaXMuZ2V0TW9kdWxlQ291bnQoKTsKICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IGxlbmd0aDsgcm93KyspIHsKICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbGVuZ3RoOyBjb2wrKykgewogICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gX3RoaXMuaXNEYXJrKHJvdywgY29sKSA/ICdibGFjaycgOiAnd2hpdGUnOwogICAgICAgIGNvbnRleHQuZmlsbFJlY3QoY29sICogY2VsbFNpemUsIHJvdyAqIGNlbGxTaXplLCBjZWxsU2l6ZSwgY2VsbFNpemUpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gX3RoaXM7Cn07CgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBxcmNvZGUuc3RyaW5nVG9CeXRlcwovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKcXJjb2RlLnN0cmluZ1RvQnl0ZXMgPSBmdW5jdGlvbihzKSB7CiAgY29uc3QgYnl0ZXMgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHMubGVuZ3RoOyBpICs9IDEpIHsKICAgIGNvbnN0IGMgPSBzLmNoYXJDb2RlQXQoaSk7CiAgICBieXRlcy5wdXNoKGMgJiAweGZmKTsKICB9CiAgcmV0dXJuIGJ5dGVzOwp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gcXJjb2RlLmNyZWF0ZVN0cmluZ1RvQnl0ZXMKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8qKgogKiBAcGFyYW0gdW5pY29kZURhdGEgYmFzZTY0IHN0cmluZyBvZiBieXRlIGFycmF5LgogKiBbMTZiaXQgVW5pY29kZV0sWzE2Yml0IEJ5dGVzXSwgLi4uCiAqIEBwYXJhbSBudW1DaGFycwogKi8KcXJjb2RlLmNyZWF0ZVN0cmluZ1RvQnl0ZXMgPSBmdW5jdGlvbih1bmljb2RlRGF0YSwgbnVtQ2hhcnMpIHsKCiAgLy8gY3JlYXRlIGNvbnZlcnNpb24gbWFwLgoKICBjb25zdCB1bmljb2RlTWFwID0gZnVuY3Rpb24oKSB7CgogICAgY29uc3QgYmluID0gYmFzZTY0RGVjb2RlSW5wdXRTdHJlYW0odW5pY29kZURhdGEpOwogICAgY29uc3QgcmVhZCA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBiID0gYmluLnJlYWQoKTsKICAgICAgaWYgKGIgPT0gLTEpIHRocm93ICdlb2YnOwogICAgICByZXR1cm4gYjsKICAgIH07CgogICAgbGV0IGNvdW50ID0gMDsKICAgIGNvbnN0IHVuaWNvZGVNYXAgPSB7fTsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIGNvbnN0IGIwID0gYmluLnJlYWQoKTsKICAgICAgaWYgKGIwID09IC0xKSBicmVhazsKICAgICAgY29uc3QgYjEgPSByZWFkKCk7CiAgICAgIGNvbnN0IGIyID0gcmVhZCgpOwogICAgICBjb25zdCBiMyA9IHJlYWQoKTsKICAgICAgY29uc3QgayA9IFN0cmluZy5mcm9tQ2hhckNvZGUoIChiMCA8PCA4KSB8IGIxKTsKICAgICAgY29uc3QgdiA9IChiMiA8PCA4KSB8IGIzOwogICAgICB1bmljb2RlTWFwW2tdID0gdjsKICAgICAgY291bnQgKz0gMTsKICAgIH0KICAgIGlmIChjb3VudCAhPSBudW1DaGFycykgewogICAgICB0aHJvdyBjb3VudCArICcgIT0gJyArIG51bUNoYXJzOwogICAgfQoKICAgIHJldHVybiB1bmljb2RlTWFwOwogIH0oKTsKCiAgY29uc3QgdW5rbm93bkNoYXIgPSAnPycuY2hhckNvZGVBdCgwKTsKCiAgcmV0dXJuIGZ1bmN0aW9uKHMpIHsKICAgIGNvbnN0IGJ5dGVzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgY29uc3QgYyA9IHMuY2hhckNvZGVBdChpKTsKICAgICAgaWYgKGMgPCAxMjgpIHsKICAgICAgICBieXRlcy5wdXNoKGMpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGIgPSB1bmljb2RlTWFwW3MuY2hhckF0KGkpXTsKICAgICAgICBpZiAodHlwZW9mIGIgPT0gJ251bWJlcicpIHsKICAgICAgICAgIGlmICggKGIgJiAweGZmKSA9PSBiKSB7CiAgICAgICAgICAgIC8vIDFieXRlCiAgICAgICAgICAgIGJ5dGVzLnB1c2goYik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyAyYnl0ZXMKICAgICAgICAgICAgYnl0ZXMucHVzaChiID4+PiA4KTsKICAgICAgICAgICAgYnl0ZXMucHVzaChiICYgMHhmZik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ5dGVzLnB1c2godW5rbm93bkNoYXIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGJ5dGVzOwogIH07Cn07CgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBRUk1vZGUKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmNvbnN0IFFSTW9kZSA9IHsKICBNT0RFX05VTUJFUiA6ICAgIDEgPDwgMCwKICBNT0RFX0FMUEhBX05VTSA6IDEgPDwgMSwKICBNT0RFXzhCSVRfQllURSA6IDEgPDwgMiwKICBNT0RFX0tBTkpJIDogICAgIDEgPDwgMwp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gUVJFcnJvckNvcnJlY3Rpb25MZXZlbAovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKY29uc3QgUVJFcnJvckNvcnJlY3Rpb25MZXZlbCA9IHsKICBMIDogMSwKICBNIDogMCwKICBRIDogMywKICBIIDogMgp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gUVJNYXNrUGF0dGVybgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKY29uc3QgUVJNYXNrUGF0dGVybiA9IHsKICBQQVRURVJOMDAwIDogMCwKICBQQVRURVJOMDAxIDogMSwKICBQQVRURVJOMDEwIDogMiwKICBQQVRURVJOMDExIDogMywKICBQQVRURVJOMTAwIDogNCwKICBQQVRURVJOMTAxIDogNSwKICBQQVRURVJOMTEwIDogNiwKICBQQVRURVJOMTExIDogNwp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gUVJVdGlsCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpjb25zdCBRUlV0aWwgPSBmdW5jdGlvbigpIHsKCiAgY29uc3QgUEFUVEVSTl9QT1NJVElPTl9UQUJMRSA9IFsKICAgIFtdLAogICAgWzYsIDE4XSwKICAgIFs2LCAyMl0sCiAgICBbNiwgMjZdLAogICAgWzYsIDMwXSwKICAgIFs2LCAzNF0sCiAgICBbNiwgMjIsIDM4XSwKICAgIFs2LCAyNCwgNDJdLAogICAgWzYsIDI2LCA0Nl0sCiAgICBbNiwgMjgsIDUwXSwKICAgIFs2LCAzMCwgNTRdLAogICAgWzYsIDMyLCA1OF0sCiAgICBbNiwgMzQsIDYyXSwKICAgIFs2LCAyNiwgNDYsIDY2XSwKICAgIFs2LCAyNiwgNDgsIDcwXSwKICAgIFs2LCAyNiwgNTAsIDc0XSwKICAgIFs2LCAzMCwgNTQsIDc4XSwKICAgIFs2LCAzMCwgNTYsIDgyXSwKICAgIFs2LCAzMCwgNTgsIDg2XSwKICAgIFs2LCAzNCwgNjIsIDkwXSwKICAgIFs2LCAyOCwgNTAsIDcyLCA5NF0sCiAgICBbNiwgMjYsIDUwLCA3NCwgOThdLAogICAgWzYsIDMwLCA1NCwgNzgsIDEwMl0sCiAgICBbNiwgMjgsIDU0LCA4MCwgMTA2XSwKICAgIFs2LCAzMiwgNTgsIDg0LCAxMTBdLAogICAgWzYsIDMwLCA1OCwgODYsIDExNF0sCiAgICBbNiwgMzQsIDYyLCA5MCwgMTE4XSwKICAgIFs2LCAyNiwgNTAsIDc0LCA5OCwgMTIyXSwKICAgIFs2LCAzMCwgNTQsIDc4LCAxMDIsIDEyNl0sCiAgICBbNiwgMjYsIDUyLCA3OCwgMTA0LCAxMzBdLAogICAgWzYsIDMwLCA1NiwgODIsIDEwOCwgMTM0XSwKICAgIFs2LCAzNCwgNjAsIDg2LCAxMTIsIDEzOF0sCiAgICBbNiwgMzAsIDU4LCA4NiwgMTE0LCAxNDJdLAogICAgWzYsIDM0LCA2MiwgOTAsIDExOCwgMTQ2XSwKICAgIFs2LCAzMCwgNTQsIDc4LCAxMDIsIDEyNiwgMTUwXSwKICAgIFs2LCAyNCwgNTAsIDc2LCAxMDIsIDEyOCwgMTU0XSwKICAgIFs2LCAyOCwgNTQsIDgwLCAxMDYsIDEzMiwgMTU4XSwKICAgIFs2LCAzMiwgNTgsIDg0LCAxMTAsIDEzNiwgMTYyXSwKICAgIFs2LCAyNiwgNTQsIDgyLCAxMTAsIDEzOCwgMTY2XSwKICAgIFs2LCAzMCwgNTgsIDg2LCAxMTQsIDE0MiwgMTcwXQogIF07CiAgY29uc3QgRzE1ID0gKDEgPDwgMTApIHwgKDEgPDwgOCkgfCAoMSA8PCA1KSB8ICgxIDw8IDQpIHwgKDEgPDwgMikgfCAoMSA8PCAxKSB8ICgxIDw8IDApOwogIGNvbnN0IEcxOCA9ICgxIDw8IDEyKSB8ICgxIDw8IDExKSB8ICgxIDw8IDEwKSB8ICgxIDw8IDkpIHwgKDEgPDwgOCkgfCAoMSA8PCA1KSB8ICgxIDw8IDIpIHwgKDEgPDwgMCk7CiAgY29uc3QgRzE1X01BU0sgPSAoMSA8PCAxNCkgfCAoMSA8PCAxMikgfCAoMSA8PCAxMCkgfCAoMSA8PCA0KSB8ICgxIDw8IDEpOwoKICBjb25zdCBfdGhpcyA9IHt9OwoKICBjb25zdCBnZXRCQ0hEaWdpdCA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGxldCBkaWdpdCA9IDA7CiAgICB3aGlsZSAoZGF0YSAhPSAwKSB7CiAgICAgIGRpZ2l0ICs9IDE7CiAgICAgIGRhdGEgPj4+PSAxOwogICAgfQogICAgcmV0dXJuIGRpZ2l0OwogIH07CgogIF90aGlzLmdldEJDSFR5cGVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgbGV0IGQgPSBkYXRhIDw8IDEwOwogICAgd2hpbGUgKGdldEJDSERpZ2l0KGQpIC0gZ2V0QkNIRGlnaXQoRzE1KSA+PSAwKSB7CiAgICAgIGQgXj0gKEcxNSA8PCAoZ2V0QkNIRGlnaXQoZCkgLSBnZXRCQ0hEaWdpdChHMTUpICkgKTsKICAgIH0KICAgIHJldHVybiAoIChkYXRhIDw8IDEwKSB8IGQpIF4gRzE1X01BU0s7CiAgfTsKCiAgX3RoaXMuZ2V0QkNIVHlwZU51bWJlciA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGxldCBkID0gZGF0YSA8PCAxMjsKICAgIHdoaWxlIChnZXRCQ0hEaWdpdChkKSAtIGdldEJDSERpZ2l0KEcxOCkgPj0gMCkgewogICAgICBkIF49IChHMTggPDwgKGdldEJDSERpZ2l0KGQpIC0gZ2V0QkNIRGlnaXQoRzE4KSApICk7CiAgICB9CiAgICByZXR1cm4gKGRhdGEgPDwgMTIpIHwgZDsKICB9OwoKICBfdGhpcy5nZXRQYXR0ZXJuUG9zaXRpb24gPSBmdW5jdGlvbih0eXBlTnVtYmVyKSB7CiAgICByZXR1cm4gUEFUVEVSTl9QT1NJVElPTl9UQUJMRVt0eXBlTnVtYmVyIC0gMV07CiAgfTsKCiAgX3RoaXMuZ2V0TWFza0Z1bmN0aW9uID0gZnVuY3Rpb24obWFza1BhdHRlcm4pIHsKCiAgICBzd2l0Y2ggKG1hc2tQYXR0ZXJuKSB7CgogICAgY2FzZSBRUk1hc2tQYXR0ZXJuLlBBVFRFUk4wMDAgOgogICAgICByZXR1cm4gZnVuY3Rpb24oaSwgaikgeyByZXR1cm4gKGkgKyBqKSAlIDIgPT0gMDsgfTsKICAgIGNhc2UgUVJNYXNrUGF0dGVybi5QQVRURVJOMDAxIDoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGksIGopIHsgcmV0dXJuIGkgJSAyID09IDA7IH07CiAgICBjYXNlIFFSTWFza1BhdHRlcm4uUEFUVEVSTjAxMCA6CiAgICAgIHJldHVybiBmdW5jdGlvbihpLCBqKSB7IHJldHVybiBqICUgMyA9PSAwOyB9OwogICAgY2FzZSBRUk1hc2tQYXR0ZXJuLlBBVFRFUk4wMTEgOgogICAgICByZXR1cm4gZnVuY3Rpb24oaSwgaikgeyByZXR1cm4gKGkgKyBqKSAlIDMgPT0gMDsgfTsKICAgIGNhc2UgUVJNYXNrUGF0dGVybi5QQVRURVJOMTAwIDoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGksIGopIHsgcmV0dXJuIChNYXRoLmZsb29yKGkgLyAyKSArIE1hdGguZmxvb3IoaiAvIDMpICkgJSAyID09IDA7IH07CiAgICBjYXNlIFFSTWFza1BhdHRlcm4uUEFUVEVSTjEwMSA6CiAgICAgIHJldHVybiBmdW5jdGlvbihpLCBqKSB7IHJldHVybiAoaSAqIGopICUgMiArIChpICogaikgJSAzID09IDA7IH07CiAgICBjYXNlIFFSTWFza1BhdHRlcm4uUEFUVEVSTjExMCA6CiAgICAgIHJldHVybiBmdW5jdGlvbihpLCBqKSB7IHJldHVybiAoIChpICogaikgJSAyICsgKGkgKiBqKSAlIDMpICUgMiA9PSAwOyB9OwogICAgY2FzZSBRUk1hc2tQYXR0ZXJuLlBBVFRFUk4xMTEgOgogICAgICByZXR1cm4gZnVuY3Rpb24oaSwgaikgeyByZXR1cm4gKCAoaSAqIGopICUgMyArIChpICsgaikgJSAyKSAlIDIgPT0gMDsgfTsKCiAgICBkZWZhdWx0IDoKICAgICAgdGhyb3cgJ2JhZCBtYXNrUGF0dGVybjonICsgbWFza1BhdHRlcm47CiAgICB9CiAgfTsKCiAgX3RoaXMuZ2V0RXJyb3JDb3JyZWN0UG9seW5vbWlhbCA9IGZ1bmN0aW9uKGVycm9yQ29ycmVjdExlbmd0aCkgewogICAgbGV0IGEgPSBxclBvbHlub21pYWwoWzFdLCAwKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXJyb3JDb3JyZWN0TGVuZ3RoOyBpICs9IDEpIHsKICAgICAgYSA9IGEubXVsdGlwbHkocXJQb2x5bm9taWFsKFsxLCBRUk1hdGguZ2V4cChpKV0sIDApICk7CiAgICB9CiAgICByZXR1cm4gYTsKICB9OwoKICBfdGhpcy5nZXRMZW5ndGhJbkJpdHMgPSBmdW5jdGlvbihtb2RlLCB0eXBlKSB7CgogICAgaWYgKDEgPD0gdHlwZSAmJiB0eXBlIDwgMTApIHsKCiAgICAgIC8vIDEgLSA5CgogICAgICBzd2l0Y2gobW9kZSkgewogICAgICBjYXNlIFFSTW9kZS5NT0RFX05VTUJFUiAgICA6IHJldHVybiAxMDsKICAgICAgY2FzZSBRUk1vZGUuTU9ERV9BTFBIQV9OVU0gOiByZXR1cm4gOTsKICAgICAgY2FzZSBRUk1vZGUuTU9ERV84QklUX0JZVEUgOiByZXR1cm4gODsKICAgICAgY2FzZSBRUk1vZGUuTU9ERV9LQU5KSSAgICAgOiByZXR1cm4gODsKICAgICAgZGVmYXVsdCA6CiAgICAgICAgdGhyb3cgJ21vZGU6JyArIG1vZGU7CiAgICAgIH0KCiAgICB9IGVsc2UgaWYgKHR5cGUgPCAyNykgewoKICAgICAgLy8gMTAgLSAyNgoKICAgICAgc3dpdGNoKG1vZGUpIHsKICAgICAgY2FzZSBRUk1vZGUuTU9ERV9OVU1CRVIgICAgOiByZXR1cm4gMTI7CiAgICAgIGNhc2UgUVJNb2RlLk1PREVfQUxQSEFfTlVNIDogcmV0dXJuIDExOwogICAgICBjYXNlIFFSTW9kZS5NT0RFXzhCSVRfQllURSA6IHJldHVybiAxNjsKICAgICAgY2FzZSBRUk1vZGUuTU9ERV9LQU5KSSAgICAgOiByZXR1cm4gMTA7CiAgICAgIGRlZmF1bHQgOgogICAgICAgIHRocm93ICdtb2RlOicgKyBtb2RlOwogICAgICB9CgogICAgfSBlbHNlIGlmICh0eXBlIDwgNDEpIHsKCiAgICAgIC8vIDI3IC0gNDAKCiAgICAgIHN3aXRjaChtb2RlKSB7CiAgICAgIGNhc2UgUVJNb2RlLk1PREVfTlVNQkVSICAgIDogcmV0dXJuIDE0OwogICAgICBjYXNlIFFSTW9kZS5NT0RFX0FMUEhBX05VTSA6IHJldHVybiAxMzsKICAgICAgY2FzZSBRUk1vZGUuTU9ERV84QklUX0JZVEUgOiByZXR1cm4gMTY7CiAgICAgIGNhc2UgUVJNb2RlLk1PREVfS0FOSkkgICAgIDogcmV0dXJuIDEyOwogICAgICBkZWZhdWx0IDoKICAgICAgICB0aHJvdyAnbW9kZTonICsgbW9kZTsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIHRocm93ICd0eXBlOicgKyB0eXBlOwogICAgfQogIH07CgogIF90aGlzLmdldExvc3RQb2ludCA9IGZ1bmN0aW9uKHFyY29kZSkgewoKICAgIGNvbnN0IG1vZHVsZUNvdW50ID0gcXJjb2RlLmdldE1vZHVsZUNvdW50KCk7CgogICAgbGV0IGxvc3RQb2ludCA9IDA7CgogICAgLy8gTEVWRUwxCgogICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgbW9kdWxlQ291bnQ7IHJvdyArPSAxKSB7CiAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IG1vZHVsZUNvdW50OyBjb2wgKz0gMSkgewoKICAgICAgICBsZXQgc2FtZUNvdW50ID0gMDsKICAgICAgICBjb25zdCBkYXJrID0gcXJjb2RlLmlzRGFyayhyb3csIGNvbCk7CgogICAgICAgIGZvciAobGV0IHIgPSAtMTsgciA8PSAxOyByICs9IDEpIHsKCiAgICAgICAgICBpZiAocm93ICsgciA8IDAgfHwgbW9kdWxlQ291bnQgPD0gcm93ICsgcikgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBmb3IgKGxldCBjID0gLTE7IGMgPD0gMTsgYyArPSAxKSB7CgogICAgICAgICAgICBpZiAoY29sICsgYyA8IDAgfHwgbW9kdWxlQ291bnQgPD0gY29sICsgYykgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAociA9PSAwICYmIGMgPT0gMCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGFyayA9PSBxcmNvZGUuaXNEYXJrKHJvdyArIHIsIGNvbCArIGMpICkgewogICAgICAgICAgICAgIHNhbWVDb3VudCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoc2FtZUNvdW50ID4gNSkgewogICAgICAgICAgbG9zdFBvaW50ICs9ICgzICsgc2FtZUNvdW50IC0gNSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIC8vIExFVkVMMgoKICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IG1vZHVsZUNvdW50IC0gMTsgcm93ICs9IDEpIHsKICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbW9kdWxlQ291bnQgLSAxOyBjb2wgKz0gMSkgewogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgaWYgKHFyY29kZS5pc0Rhcmsocm93LCBjb2wpICkgY291bnQgKz0gMTsKICAgICAgICBpZiAocXJjb2RlLmlzRGFyayhyb3cgKyAxLCBjb2wpICkgY291bnQgKz0gMTsKICAgICAgICBpZiAocXJjb2RlLmlzRGFyayhyb3csIGNvbCArIDEpICkgY291bnQgKz0gMTsKICAgICAgICBpZiAocXJjb2RlLmlzRGFyayhyb3cgKyAxLCBjb2wgKyAxKSApIGNvdW50ICs9IDE7CiAgICAgICAgaWYgKGNvdW50ID09IDAgfHwgY291bnQgPT0gNCkgewogICAgICAgICAgbG9zdFBvaW50ICs9IDM7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gTEVWRUwzCgogICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgbW9kdWxlQ291bnQ7IHJvdyArPSAxKSB7CiAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IG1vZHVsZUNvdW50IC0gNjsgY29sICs9IDEpIHsKICAgICAgICBpZiAocXJjb2RlLmlzRGFyayhyb3csIGNvbCkKICAgICAgICAgICAgJiYgIXFyY29kZS5pc0Rhcmsocm93LCBjb2wgKyAxKQogICAgICAgICAgICAmJiAgcXJjb2RlLmlzRGFyayhyb3csIGNvbCArIDIpCiAgICAgICAgICAgICYmICBxcmNvZGUuaXNEYXJrKHJvdywgY29sICsgMykKICAgICAgICAgICAgJiYgIHFyY29kZS5pc0Rhcmsocm93LCBjb2wgKyA0KQogICAgICAgICAgICAmJiAhcXJjb2RlLmlzRGFyayhyb3csIGNvbCArIDUpCiAgICAgICAgICAgICYmICBxcmNvZGUuaXNEYXJrKHJvdywgY29sICsgNikgKSB7CiAgICAgICAgICBsb3N0UG9pbnQgKz0gNDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbW9kdWxlQ291bnQ7IGNvbCArPSAxKSB7CiAgICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IG1vZHVsZUNvdW50IC0gNjsgcm93ICs9IDEpIHsKICAgICAgICBpZiAocXJjb2RlLmlzRGFyayhyb3csIGNvbCkKICAgICAgICAgICAgJiYgIXFyY29kZS5pc0Rhcmsocm93ICsgMSwgY29sKQogICAgICAgICAgICAmJiAgcXJjb2RlLmlzRGFyayhyb3cgKyAyLCBjb2wpCiAgICAgICAgICAgICYmICBxcmNvZGUuaXNEYXJrKHJvdyArIDMsIGNvbCkKICAgICAgICAgICAgJiYgIHFyY29kZS5pc0Rhcmsocm93ICsgNCwgY29sKQogICAgICAgICAgICAmJiAhcXJjb2RlLmlzRGFyayhyb3cgKyA1LCBjb2wpCiAgICAgICAgICAgICYmICBxcmNvZGUuaXNEYXJrKHJvdyArIDYsIGNvbCkgKSB7CiAgICAgICAgICBsb3N0UG9pbnQgKz0gNDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gTEVWRUw0CgogICAgbGV0IGRhcmtDb3VudCA9IDA7CgogICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbW9kdWxlQ291bnQ7IGNvbCArPSAxKSB7CiAgICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IG1vZHVsZUNvdW50OyByb3cgKz0gMSkgewogICAgICAgIGlmIChxcmNvZGUuaXNEYXJrKHJvdywgY29sKSApIHsKICAgICAgICAgIGRhcmtDb3VudCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbnN0IHJhdGlvID0gTWF0aC5hYnMoMTAwICogZGFya0NvdW50IC8gbW9kdWxlQ291bnQgLyBtb2R1bGVDb3VudCAtIDUwKSAvIDU7CiAgICBsb3N0UG9pbnQgKz0gcmF0aW8gKiAxMDsKCiAgICByZXR1cm4gbG9zdFBvaW50OwogIH07CgogIHJldHVybiBfdGhpczsKfSgpOwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gUVJNYXRoCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpjb25zdCBRUk1hdGggPSBmdW5jdGlvbigpIHsKCiAgY29uc3QgRVhQX1RBQkxFID0gbmV3IEFycmF5KDI1Nik7CiAgY29uc3QgTE9HX1RBQkxFID0gbmV3IEFycmF5KDI1Nik7CgogIC8vIGluaXRpYWxpemUgdGFibGVzCiAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyBpICs9IDEpIHsKICAgIEVYUF9UQUJMRVtpXSA9IDEgPDwgaTsKICB9CiAgZm9yIChsZXQgaSA9IDg7IGkgPCAyNTY7IGkgKz0gMSkgewogICAgRVhQX1RBQkxFW2ldID0gRVhQX1RBQkxFW2kgLSA0XQogICAgICBeIEVYUF9UQUJMRVtpIC0gNV0KICAgICAgXiBFWFBfVEFCTEVbaSAtIDZdCiAgICAgIF4gRVhQX1RBQkxFW2kgLSA4XTsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTU7IGkgKz0gMSkgewogICAgTE9HX1RBQkxFW0VYUF9UQUJMRVtpXSBdID0gaTsKICB9CgogIGNvbnN0IF90aGlzID0ge307CgogIF90aGlzLmdsb2cgPSBmdW5jdGlvbihuKSB7CgogICAgaWYgKG4gPCAxKSB7CiAgICAgIHRocm93ICdnbG9nKCcgKyBuICsgJyknOwogICAgfQoKICAgIHJldHVybiBMT0dfVEFCTEVbbl07CiAgfTsKCiAgX3RoaXMuZ2V4cCA9IGZ1bmN0aW9uKG4pIHsKCiAgICB3aGlsZSAobiA8IDApIHsKICAgICAgbiArPSAyNTU7CiAgICB9CgogICAgd2hpbGUgKG4gPj0gMjU2KSB7CiAgICAgIG4gLT0gMjU1OwogICAgfQoKICAgIHJldHVybiBFWFBfVEFCTEVbbl07CiAgfTsKCiAgcmV0dXJuIF90aGlzOwp9KCk7CgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBxclBvbHlub21pYWwKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmNvbnN0IHFyUG9seW5vbWlhbCA9IGZ1bmN0aW9uKG51bSwgc2hpZnQpIHsKCiAgaWYgKHR5cGVvZiBudW0ubGVuZ3RoID09ICd1bmRlZmluZWQnKSB7CiAgICB0aHJvdyBudW0ubGVuZ3RoICsgJy8nICsgc2hpZnQ7CiAgfQoKICBjb25zdCBfbnVtID0gZnVuY3Rpb24oKSB7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHdoaWxlIChvZmZzZXQgPCBudW0ubGVuZ3RoICYmIG51bVtvZmZzZXRdID09IDApIHsKICAgICAgb2Zmc2V0ICs9IDE7CiAgICB9CiAgICBjb25zdCBfbnVtID0gbmV3IEFycmF5KG51bS5sZW5ndGggLSBvZmZzZXQgKyBzaGlmdCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bS5sZW5ndGggLSBvZmZzZXQ7IGkgKz0gMSkgewogICAgICBfbnVtW2ldID0gbnVtW2kgKyBvZmZzZXRdOwogICAgfQogICAgcmV0dXJuIF9udW07CiAgfSgpOwoKICBjb25zdCBfdGhpcyA9IHt9OwoKICBfdGhpcy5nZXRBdCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gX251bVtpbmRleF07CiAgfTsKCiAgX3RoaXMuZ2V0TGVuZ3RoID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gX251bS5sZW5ndGg7CiAgfTsKCiAgX3RoaXMubXVsdGlwbHkgPSBmdW5jdGlvbihlKSB7CgogICAgY29uc3QgbnVtID0gbmV3IEFycmF5KF90aGlzLmdldExlbmd0aCgpICsgZS5nZXRMZW5ndGgoKSAtIDEpOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgX3RoaXMuZ2V0TGVuZ3RoKCk7IGkgKz0gMSkgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGUuZ2V0TGVuZ3RoKCk7IGogKz0gMSkgewogICAgICAgIG51bVtpICsgal0gXj0gUVJNYXRoLmdleHAoUVJNYXRoLmdsb2coX3RoaXMuZ2V0QXQoaSkgKSArIFFSTWF0aC5nbG9nKGUuZ2V0QXQoaikgKSApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHFyUG9seW5vbWlhbChudW0sIDApOwogIH07CgogIF90aGlzLm1vZCA9IGZ1bmN0aW9uKGUpIHsKCiAgICBpZiAoX3RoaXMuZ2V0TGVuZ3RoKCkgLSBlLmdldExlbmd0aCgpIDwgMCkgewogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgY29uc3QgcmF0aW8gPSBRUk1hdGguZ2xvZyhfdGhpcy5nZXRBdCgwKSApIC0gUVJNYXRoLmdsb2coZS5nZXRBdCgwKSApOwoKICAgIGNvbnN0IG51bSA9IG5ldyBBcnJheShfdGhpcy5nZXRMZW5ndGgoKSApOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBfdGhpcy5nZXRMZW5ndGgoKTsgaSArPSAxKSB7CiAgICAgIG51bVtpXSA9IF90aGlzLmdldEF0KGkpOwogICAgfQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZS5nZXRMZW5ndGgoKTsgaSArPSAxKSB7CiAgICAgIG51bVtpXSBePSBRUk1hdGguZ2V4cChRUk1hdGguZ2xvZyhlLmdldEF0KGkpICkgKyByYXRpbyk7CiAgICB9CgogICAgLy8gcmVjdXJzaXZlIGNhbGwKICAgIHJldHVybiBxclBvbHlub21pYWwobnVtLCAwKS5tb2QoZSk7CiAgfTsKCiAgcmV0dXJuIF90aGlzOwp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gUVJSU0Jsb2NrCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpjb25zdCBRUlJTQmxvY2sgPSBmdW5jdGlvbigpIHsKCiAgY29uc3QgUlNfQkxPQ0tfVEFCTEUgPSBbCgogICAgLy8gTAogICAgLy8gTQogICAgLy8gUQogICAgLy8gSAoKICAgIC8vIDEKICAgIFsxLCAyNiwgMTldLAogICAgWzEsIDI2LCAxNl0sCiAgICBbMSwgMjYsIDEzXSwKICAgIFsxLCAyNiwgOV0sCgogICAgLy8gMgogICAgWzEsIDQ0LCAzNF0sCiAgICBbMSwgNDQsIDI4XSwKICAgIFsxLCA0NCwgMjJdLAogICAgWzEsIDQ0LCAxNl0sCgogICAgLy8gMwogICAgWzEsIDcwLCA1NV0sCiAgICBbMSwgNzAsIDQ0XSwKICAgIFsyLCAzNSwgMTddLAogICAgWzIsIDM1LCAxM10sCgogICAgLy8gNAogICAgWzEsIDEwMCwgODBdLAogICAgWzIsIDUwLCAzMl0sCiAgICBbMiwgNTAsIDI0XSwKICAgIFs0LCAyNSwgOV0sCgogICAgLy8gNQogICAgWzEsIDEzNCwgMTA4XSwKICAgIFsyLCA2NywgNDNdLAogICAgWzIsIDMzLCAxNSwgMiwgMzQsIDE2XSwKICAgIFsyLCAzMywgMTEsIDIsIDM0LCAxMl0sCgogICAgLy8gNgogICAgWzIsIDg2LCA2OF0sCiAgICBbNCwgNDMsIDI3XSwKICAgIFs0LCA0MywgMTldLAogICAgWzQsIDQzLCAxNV0sCgogICAgLy8gNwogICAgWzIsIDk4LCA3OF0sCiAgICBbNCwgNDksIDMxXSwKICAgIFsyLCAzMiwgMTQsIDQsIDMzLCAxNV0sCiAgICBbNCwgMzksIDEzLCAxLCA0MCwgMTRdLAoKICAgIC8vIDgKICAgIFsyLCAxMjEsIDk3XSwKICAgIFsyLCA2MCwgMzgsIDIsIDYxLCAzOV0sCiAgICBbNCwgNDAsIDE4LCAyLCA0MSwgMTldLAogICAgWzQsIDQwLCAxNCwgMiwgNDEsIDE1XSwKCiAgICAvLyA5CiAgICBbMiwgMTQ2LCAxMTZdLAogICAgWzMsIDU4LCAzNiwgMiwgNTksIDM3XSwKICAgIFs0LCAzNiwgMTYsIDQsIDM3LCAxN10sCiAgICBbNCwgMzYsIDEyLCA0LCAzNywgMTNdLAoKICAgIC8vIDEwCiAgICBbMiwgODYsIDY4LCAyLCA4NywgNjldLAogICAgWzQsIDY5LCA0MywgMSwgNzAsIDQ0XSwKICAgIFs2LCA0MywgMTksIDIsIDQ0LCAyMF0sCiAgICBbNiwgNDMsIDE1LCAyLCA0NCwgMTZdLAoKICAgIC8vIDExCiAgICBbNCwgMTAxLCA4MV0sCiAgICBbMSwgODAsIDUwLCA0LCA4MSwgNTFdLAogICAgWzQsIDUwLCAyMiwgNCwgNTEsIDIzXSwKICAgIFszLCAzNiwgMTIsIDgsIDM3LCAxM10sCgogICAgLy8gMTIKICAgIFsyLCAxMTYsIDkyLCAyLCAxMTcsIDkzXSwKICAgIFs2LCA1OCwgMzYsIDIsIDU5LCAzN10sCiAgICBbNCwgNDYsIDIwLCA2LCA0NywgMjFdLAogICAgWzcsIDQyLCAxNCwgNCwgNDMsIDE1XSwKCiAgICAvLyAxMwogICAgWzQsIDEzMywgMTA3XSwKICAgIFs4LCA1OSwgMzcsIDEsIDYwLCAzOF0sCiAgICBbOCwgNDQsIDIwLCA0LCA0NSwgMjFdLAogICAgWzEyLCAzMywgMTEsIDQsIDM0LCAxMl0sCgogICAgLy8gMTQKICAgIFszLCAxNDUsIDExNSwgMSwgMTQ2LCAxMTZdLAogICAgWzQsIDY0LCA0MCwgNSwgNjUsIDQxXSwKICAgIFsxMSwgMzYsIDE2LCA1LCAzNywgMTddLAogICAgWzExLCAzNiwgMTIsIDUsIDM3LCAxM10sCgogICAgLy8gMTUKICAgIFs1LCAxMDksIDg3LCAxLCAxMTAsIDg4XSwKICAgIFs1LCA2NSwgNDEsIDUsIDY2LCA0Ml0sCiAgICBbNSwgNTQsIDI0LCA3LCA1NSwgMjVdLAogICAgWzExLCAzNiwgMTIsIDcsIDM3LCAxM10sCgogICAgLy8gMTYKICAgIFs1LCAxMjIsIDk4LCAxLCAxMjMsIDk5XSwKICAgIFs3LCA3MywgNDUsIDMsIDc0LCA0Nl0sCiAgICBbMTUsIDQzLCAxOSwgMiwgNDQsIDIwXSwKICAgIFszLCA0NSwgMTUsIDEzLCA0NiwgMTZdLAoKICAgIC8vIDE3CiAgICBbMSwgMTM1LCAxMDcsIDUsIDEzNiwgMTA4XSwKICAgIFsxMCwgNzQsIDQ2LCAxLCA3NSwgNDddLAogICAgWzEsIDUwLCAyMiwgMTUsIDUxLCAyM10sCiAgICBbMiwgNDIsIDE0LCAxNywgNDMsIDE1XSwKCiAgICAvLyAxOAogICAgWzUsIDE1MCwgMTIwLCAxLCAxNTEsIDEyMV0sCiAgICBbOSwgNjksIDQzLCA0LCA3MCwgNDRdLAogICAgWzE3LCA1MCwgMjIsIDEsIDUxLCAyM10sCiAgICBbMiwgNDIsIDE0LCAxOSwgNDMsIDE1XSwKCiAgICAvLyAxOQogICAgWzMsIDE0MSwgMTEzLCA0LCAxNDIsIDExNF0sCiAgICBbMywgNzAsIDQ0LCAxMSwgNzEsIDQ1XSwKICAgIFsxNywgNDcsIDIxLCA0LCA0OCwgMjJdLAogICAgWzksIDM5LCAxMywgMTYsIDQwLCAxNF0sCgogICAgLy8gMjAKICAgIFszLCAxMzUsIDEwNywgNSwgMTM2LCAxMDhdLAogICAgWzMsIDY3LCA0MSwgMTMsIDY4LCA0Ml0sCiAgICBbMTUsIDU0LCAyNCwgNSwgNTUsIDI1XSwKICAgIFsxNSwgNDMsIDE1LCAxMCwgNDQsIDE2XSwKCiAgICAvLyAyMQogICAgWzQsIDE0NCwgMTE2LCA0LCAxNDUsIDExN10sCiAgICBbMTcsIDY4LCA0Ml0sCiAgICBbMTcsIDUwLCAyMiwgNiwgNTEsIDIzXSwKICAgIFsxOSwgNDYsIDE2LCA2LCA0NywgMTddLAoKICAgIC8vIDIyCiAgICBbMiwgMTM5LCAxMTEsIDcsIDE0MCwgMTEyXSwKICAgIFsxNywgNzQsIDQ2XSwKICAgIFs3LCA1NCwgMjQsIDE2LCA1NSwgMjVdLAogICAgWzM0LCAzNywgMTNdLAoKICAgIC8vIDIzCiAgICBbNCwgMTUxLCAxMjEsIDUsIDE1MiwgMTIyXSwKICAgIFs0LCA3NSwgNDcsIDE0LCA3NiwgNDhdLAogICAgWzExLCA1NCwgMjQsIDE0LCA1NSwgMjVdLAogICAgWzE2LCA0NSwgMTUsIDE0LCA0NiwgMTZdLAoKICAgIC8vIDI0CiAgICBbNiwgMTQ3LCAxMTcsIDQsIDE0OCwgMTE4XSwKICAgIFs2LCA3MywgNDUsIDE0LCA3NCwgNDZdLAogICAgWzExLCA1NCwgMjQsIDE2LCA1NSwgMjVdLAogICAgWzMwLCA0NiwgMTYsIDIsIDQ3LCAxN10sCgogICAgLy8gMjUKICAgIFs4LCAxMzIsIDEwNiwgNCwgMTMzLCAxMDddLAogICAgWzgsIDc1LCA0NywgMTMsIDc2LCA0OF0sCiAgICBbNywgNTQsIDI0LCAyMiwgNTUsIDI1XSwKICAgIFsyMiwgNDUsIDE1LCAxMywgNDYsIDE2XSwKCiAgICAvLyAyNgogICAgWzEwLCAxNDIsIDExNCwgMiwgMTQzLCAxMTVdLAogICAgWzE5LCA3NCwgNDYsIDQsIDc1LCA0N10sCiAgICBbMjgsIDUwLCAyMiwgNiwgNTEsIDIzXSwKICAgIFszMywgNDYsIDE2LCA0LCA0NywgMTddLAoKICAgIC8vIDI3CiAgICBbOCwgMTUyLCAxMjIsIDQsIDE1MywgMTIzXSwKICAgIFsyMiwgNzMsIDQ1LCAzLCA3NCwgNDZdLAogICAgWzgsIDUzLCAyMywgMjYsIDU0LCAyNF0sCiAgICBbMTIsIDQ1LCAxNSwgMjgsIDQ2LCAxNl0sCgogICAgLy8gMjgKICAgIFszLCAxNDcsIDExNywgMTAsIDE0OCwgMTE4XSwKICAgIFszLCA3MywgNDUsIDIzLCA3NCwgNDZdLAogICAgWzQsIDU0LCAyNCwgMzEsIDU1LCAyNV0sCiAgICBbMTEsIDQ1LCAxNSwgMzEsIDQ2LCAxNl0sCgogICAgLy8gMjkKICAgIFs3LCAxNDYsIDExNiwgNywgMTQ3LCAxMTddLAogICAgWzIxLCA3MywgNDUsIDcsIDc0LCA0Nl0sCiAgICBbMSwgNTMsIDIzLCAzNywgNTQsIDI0XSwKICAgIFsxOSwgNDUsIDE1LCAyNiwgNDYsIDE2XSwKCiAgICAvLyAzMAogICAgWzUsIDE0NSwgMTE1LCAxMCwgMTQ2LCAxMTZdLAogICAgWzE5LCA3NSwgNDcsIDEwLCA3NiwgNDhdLAogICAgWzE1LCA1NCwgMjQsIDI1LCA1NSwgMjVdLAogICAgWzIzLCA0NSwgMTUsIDI1LCA0NiwgMTZdLAoKICAgIC8vIDMxCiAgICBbMTMsIDE0NSwgMTE1LCAzLCAxNDYsIDExNl0sCiAgICBbMiwgNzQsIDQ2LCAyOSwgNzUsIDQ3XSwKICAgIFs0MiwgNTQsIDI0LCAxLCA1NSwgMjVdLAogICAgWzIzLCA0NSwgMTUsIDI4LCA0NiwgMTZdLAoKICAgIC8vIDMyCiAgICBbMTcsIDE0NSwgMTE1XSwKICAgIFsxMCwgNzQsIDQ2LCAyMywgNzUsIDQ3XSwKICAgIFsxMCwgNTQsIDI0LCAzNSwgNTUsIDI1XSwKICAgIFsxOSwgNDUsIDE1LCAzNSwgNDYsIDE2XSwKCiAgICAvLyAzMwogICAgWzE3LCAxNDUsIDExNSwgMSwgMTQ2LCAxMTZdLAogICAgWzE0LCA3NCwgNDYsIDIxLCA3NSwgNDddLAogICAgWzI5LCA1NCwgMjQsIDE5LCA1NSwgMjVdLAogICAgWzExLCA0NSwgMTUsIDQ2LCA0NiwgMTZdLAoKICAgIC8vIDM0CiAgICBbMTMsIDE0NSwgMTE1LCA2LCAxNDYsIDExNl0sCiAgICBbMTQsIDc0LCA0NiwgMjMsIDc1LCA0N10sCiAgICBbNDQsIDU0LCAyNCwgNywgNTUsIDI1XSwKICAgIFs1OSwgNDYsIDE2LCAxLCA0NywgMTddLAoKICAgIC8vIDM1CiAgICBbMTIsIDE1MSwgMTIxLCA3LCAxNTIsIDEyMl0sCiAgICBbMTIsIDc1LCA0NywgMjYsIDc2LCA0OF0sCiAgICBbMzksIDU0LCAyNCwgMTQsIDU1LCAyNV0sCiAgICBbMjIsIDQ1LCAxNSwgNDEsIDQ2LCAxNl0sCgogICAgLy8gMzYKICAgIFs2LCAxNTEsIDEyMSwgMTQsIDE1MiwgMTIyXSwKICAgIFs2LCA3NSwgNDcsIDM0LCA3NiwgNDhdLAogICAgWzQ2LCA1NCwgMjQsIDEwLCA1NSwgMjVdLAogICAgWzIsIDQ1LCAxNSwgNjQsIDQ2LCAxNl0sCgogICAgLy8gMzcKICAgIFsxNywgMTUyLCAxMjIsIDQsIDE1MywgMTIzXSwKICAgIFsyOSwgNzQsIDQ2LCAxNCwgNzUsIDQ3XSwKICAgIFs0OSwgNTQsIDI0LCAxMCwgNTUsIDI1XSwKICAgIFsyNCwgNDUsIDE1LCA0NiwgNDYsIDE2XSwKCiAgICAvLyAzOAogICAgWzQsIDE1MiwgMTIyLCAxOCwgMTUzLCAxMjNdLAogICAgWzEzLCA3NCwgNDYsIDMyLCA3NSwgNDddLAogICAgWzQ4LCA1NCwgMjQsIDE0LCA1NSwgMjVdLAogICAgWzQyLCA0NSwgMTUsIDMyLCA0NiwgMTZdLAoKICAgIC8vIDM5CiAgICBbMjAsIDE0NywgMTE3LCA0LCAxNDgsIDExOF0sCiAgICBbNDAsIDc1LCA0NywgNywgNzYsIDQ4XSwKICAgIFs0MywgNTQsIDI0LCAyMiwgNTUsIDI1XSwKICAgIFsxMCwgNDUsIDE1LCA2NywgNDYsIDE2XSwKCiAgICAvLyA0MAogICAgWzE5LCAxNDgsIDExOCwgNiwgMTQ5LCAxMTldLAogICAgWzE4LCA3NSwgNDcsIDMxLCA3NiwgNDhdLAogICAgWzM0LCA1NCwgMjQsIDM0LCA1NSwgMjVdLAogICAgWzIwLCA0NSwgMTUsIDYxLCA0NiwgMTZdCiAgXTsKCiAgY29uc3QgcXJSU0Jsb2NrID0gZnVuY3Rpb24odG90YWxDb3VudCwgZGF0YUNvdW50KSB7CiAgICBjb25zdCBfdGhpcyA9IHt9OwogICAgX3RoaXMudG90YWxDb3VudCA9IHRvdGFsQ291bnQ7CiAgICBfdGhpcy5kYXRhQ291bnQgPSBkYXRhQ291bnQ7CiAgICByZXR1cm4gX3RoaXM7CiAgfTsKCiAgY29uc3QgX3RoaXMgPSB7fTsKCiAgY29uc3QgZ2V0UnNCbG9ja1RhYmxlID0gZnVuY3Rpb24odHlwZU51bWJlciwgZXJyb3JDb3JyZWN0aW9uTGV2ZWwpIHsKCiAgICBzd2l0Y2goZXJyb3JDb3JyZWN0aW9uTGV2ZWwpIHsKICAgIGNhc2UgUVJFcnJvckNvcnJlY3Rpb25MZXZlbC5MIDoKICAgICAgcmV0dXJuIFJTX0JMT0NLX1RBQkxFWyh0eXBlTnVtYmVyIC0gMSkgKiA0ICsgMF07CiAgICBjYXNlIFFSRXJyb3JDb3JyZWN0aW9uTGV2ZWwuTSA6CiAgICAgIHJldHVybiBSU19CTE9DS19UQUJMRVsodHlwZU51bWJlciAtIDEpICogNCArIDFdOwogICAgY2FzZSBRUkVycm9yQ29ycmVjdGlvbkxldmVsLlEgOgogICAgICByZXR1cm4gUlNfQkxPQ0tfVEFCTEVbKHR5cGVOdW1iZXIgLSAxKSAqIDQgKyAyXTsKICAgIGNhc2UgUVJFcnJvckNvcnJlY3Rpb25MZXZlbC5IIDoKICAgICAgcmV0dXJuIFJTX0JMT0NLX1RBQkxFWyh0eXBlTnVtYmVyIC0gMSkgKiA0ICsgM107CiAgICBkZWZhdWx0IDoKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICB9OwoKICBfdGhpcy5nZXRSU0Jsb2NrcyA9IGZ1bmN0aW9uKHR5cGVOdW1iZXIsIGVycm9yQ29ycmVjdGlvbkxldmVsKSB7CgogICAgY29uc3QgcnNCbG9jayA9IGdldFJzQmxvY2tUYWJsZSh0eXBlTnVtYmVyLCBlcnJvckNvcnJlY3Rpb25MZXZlbCk7CgogICAgaWYgKHR5cGVvZiByc0Jsb2NrID09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRocm93ICdiYWQgcnMgYmxvY2sgQCB0eXBlTnVtYmVyOicgKyB0eXBlTnVtYmVyICsKICAgICAgICAgICcvZXJyb3JDb3JyZWN0aW9uTGV2ZWw6JyArIGVycm9yQ29ycmVjdGlvbkxldmVsOwogICAgfQoKICAgIGNvbnN0IGxlbmd0aCA9IHJzQmxvY2subGVuZ3RoIC8gMzsKCiAgICBjb25zdCBsaXN0ID0gW107CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewoKICAgICAgY29uc3QgY291bnQgPSByc0Jsb2NrW2kgKiAzICsgMF07CiAgICAgIGNvbnN0IHRvdGFsQ291bnQgPSByc0Jsb2NrW2kgKiAzICsgMV07CiAgICAgIGNvbnN0IGRhdGFDb3VudCA9IHJzQmxvY2tbaSAqIDMgKyAyXTsKCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY291bnQ7IGogKz0gMSkgewogICAgICAgIGxpc3QucHVzaChxclJTQmxvY2sodG90YWxDb3VudCwgZGF0YUNvdW50KSApOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGxpc3Q7CiAgfTsKCiAgcmV0dXJuIF90aGlzOwp9KCk7CgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBxckJpdEJ1ZmZlcgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKY29uc3QgcXJCaXRCdWZmZXIgPSBmdW5jdGlvbigpIHsKCiAgY29uc3QgX2J1ZmZlciA9IFtdOwogIGxldCBfbGVuZ3RoID0gMDsKCiAgY29uc3QgX3RoaXMgPSB7fTsKCiAgX3RoaXMuZ2V0QnVmZmVyID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gX2J1ZmZlcjsKICB9OwoKICBfdGhpcy5nZXRBdCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICBjb25zdCBidWZJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggLyA4KTsKICAgIHJldHVybiAoIChfYnVmZmVyW2J1ZkluZGV4XSA+Pj4gKDcgLSBpbmRleCAlIDgpICkgJiAxKSA9PSAxOwogIH07CgogIF90aGlzLnB1dCA9IGZ1bmN0aW9uKG51bSwgbGVuZ3RoKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICAgIF90aGlzLnB1dEJpdCggKCAobnVtID4+PiAobGVuZ3RoIC0gaSAtIDEpICkgJiAxKSA9PSAxKTsKICAgIH0KICB9OwoKICBfdGhpcy5nZXRMZW5ndGhJbkJpdHMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfbGVuZ3RoOwogIH07CgogIF90aGlzLnB1dEJpdCA9IGZ1bmN0aW9uKGJpdCkgewoKICAgIGNvbnN0IGJ1ZkluZGV4ID0gTWF0aC5mbG9vcihfbGVuZ3RoIC8gOCk7CiAgICBpZiAoX2J1ZmZlci5sZW5ndGggPD0gYnVmSW5kZXgpIHsKICAgICAgX2J1ZmZlci5wdXNoKDApOwogICAgfQoKICAgIGlmIChiaXQpIHsKICAgICAgX2J1ZmZlcltidWZJbmRleF0gfD0gKDB4ODAgPj4+IChfbGVuZ3RoICUgOCkgKTsKICAgIH0KCiAgICBfbGVuZ3RoICs9IDE7CiAgfTsKCiAgcmV0dXJuIF90aGlzOwp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gcXJOdW1iZXIKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmNvbnN0IHFyTnVtYmVyID0gZnVuY3Rpb24oZGF0YSkgewoKICBjb25zdCBfbW9kZSA9IFFSTW9kZS5NT0RFX05VTUJFUjsKICBjb25zdCBfZGF0YSA9IGRhdGE7CgogIGNvbnN0IF90aGlzID0ge307CgogIF90aGlzLmdldE1vZGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfbW9kZTsKICB9OwoKICBfdGhpcy5nZXRMZW5ndGggPSBmdW5jdGlvbihidWZmZXIpIHsKICAgIHJldHVybiBfZGF0YS5sZW5ndGg7CiAgfTsKCiAgX3RoaXMud3JpdGUgPSBmdW5jdGlvbihidWZmZXIpIHsKCiAgICBjb25zdCBkYXRhID0gX2RhdGE7CgogICAgbGV0IGkgPSAwOwoKICAgIHdoaWxlIChpICsgMiA8IGRhdGEubGVuZ3RoKSB7CiAgICAgIGJ1ZmZlci5wdXQoc3RyVG9OdW0oZGF0YS5zdWJzdHJpbmcoaSwgaSArIDMpICksIDEwKTsKICAgICAgaSArPSAzOwogICAgfQoKICAgIGlmIChpIDwgZGF0YS5sZW5ndGgpIHsKICAgICAgaWYgKGRhdGEubGVuZ3RoIC0gaSA9PSAxKSB7CiAgICAgICAgYnVmZmVyLnB1dChzdHJUb051bShkYXRhLnN1YnN0cmluZyhpLCBpICsgMSkgKSwgNCk7CiAgICAgIH0gZWxzZSBpZiAoZGF0YS5sZW5ndGggLSBpID09IDIpIHsKICAgICAgICBidWZmZXIucHV0KHN0clRvTnVtKGRhdGEuc3Vic3RyaW5nKGksIGkgKyAyKSApLCA3KTsKICAgICAgfQogICAgfQogIH07CgogIGNvbnN0IHN0clRvTnVtID0gZnVuY3Rpb24ocykgewogICAgbGV0IG51bSA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgbnVtID0gbnVtICogMTAgKyBjaGF0VG9OdW0ocy5jaGFyQXQoaSkgKTsKICAgIH0KICAgIHJldHVybiBudW07CiAgfTsKCiAgY29uc3QgY2hhdFRvTnVtID0gZnVuY3Rpb24oYykgewogICAgaWYgKCcwJyA8PSBjICYmIGMgPD0gJzknKSB7CiAgICAgIHJldHVybiBjLmNoYXJDb2RlQXQoMCkgLSAnMCcuY2hhckNvZGVBdCgwKTsKICAgIH0KICAgIHRocm93ICdpbGxlZ2FsIGNoYXIgOicgKyBjOwogIH07CgogIHJldHVybiBfdGhpczsKfTsKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIHFyQWxwaGFOdW0KLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmNvbnN0IHFyQWxwaGFOdW0gPSBmdW5jdGlvbihkYXRhKSB7CgogIGNvbnN0IF9tb2RlID0gUVJNb2RlLk1PREVfQUxQSEFfTlVNOwogIGNvbnN0IF9kYXRhID0gZGF0YTsKCiAgY29uc3QgX3RoaXMgPSB7fTsKCiAgX3RoaXMuZ2V0TW9kZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF9tb2RlOwogIH07CgogIF90aGlzLmdldExlbmd0aCA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgcmV0dXJuIF9kYXRhLmxlbmd0aDsKICB9OwoKICBfdGhpcy53cml0ZSA9IGZ1bmN0aW9uKGJ1ZmZlcikgewoKICAgIGNvbnN0IHMgPSBfZGF0YTsKCiAgICBsZXQgaSA9IDA7CgogICAgd2hpbGUgKGkgKyAxIDwgcy5sZW5ndGgpIHsKICAgICAgYnVmZmVyLnB1dCgKICAgICAgICBnZXRDb2RlKHMuY2hhckF0KGkpICkgKiA0NSArCiAgICAgICAgZ2V0Q29kZShzLmNoYXJBdChpICsgMSkgKSwgMTEpOwogICAgICBpICs9IDI7CiAgICB9CgogICAgaWYgKGkgPCBzLmxlbmd0aCkgewogICAgICBidWZmZXIucHV0KGdldENvZGUocy5jaGFyQXQoaSkgKSwgNik7CiAgICB9CiAgfTsKCiAgY29uc3QgZ2V0Q29kZSA9IGZ1bmN0aW9uKGMpIHsKCiAgICBpZiAoJzAnIDw9IGMgJiYgYyA8PSAnOScpIHsKICAgICAgcmV0dXJuIGMuY2hhckNvZGVBdCgwKSAtICcwJy5jaGFyQ29kZUF0KDApOwogICAgfSBlbHNlIGlmICgnQScgPD0gYyAmJiBjIDw9ICdaJykgewogICAgICByZXR1cm4gYy5jaGFyQ29kZUF0KDApIC0gJ0EnLmNoYXJDb2RlQXQoMCkgKyAxMDsKICAgIH0gZWxzZSB7CiAgICAgIHN3aXRjaCAoYykgewogICAgICBjYXNlICdcdTAwMjAnIDogcmV0dXJuIDM2OwogICAgICBjYXNlICckJyA6IHJldHVybiAzNzsKICAgICAgY2FzZSAnJScgOiByZXR1cm4gMzg7CiAgICAgIGNhc2UgJyonIDogcmV0dXJuIDM5OwogICAgICBjYXNlICcrJyA6IHJldHVybiA0MDsKICAgICAgY2FzZSAnLScgOiByZXR1cm4gNDE7CiAgICAgIGNhc2UgJy4nIDogcmV0dXJuIDQyOwogICAgICBjYXNlICcvJyA6IHJldHVybiA0MzsKICAgICAgY2FzZSAnOicgOiByZXR1cm4gNDQ7CiAgICAgIGRlZmF1bHQgOgogICAgICAgIHRocm93ICdpbGxlZ2FsIGNoYXIgOicgKyBjOwogICAgICB9CiAgICB9CiAgfTsKCiAgcmV0dXJuIF90aGlzOwp9OwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gcXI4Qml0Qnl0ZQovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKY29uc3QgcXI4Qml0Qnl0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKCiAgY29uc3QgX21vZGUgPSBRUk1vZGUuTU9ERV84QklUX0JZVEU7CiAgY29uc3QgX2RhdGEgPSBkYXRhOwogIGNvbnN0IF9ieXRlcyA9IHFyY29kZS5zdHJpbmdUb0J5dGVzKGRhdGEpOwoKICBjb25zdCBfdGhpcyA9IHt9OwoKICBfdGhpcy5nZXRNb2RlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gX21vZGU7CiAgfTsKCiAgX3RoaXMuZ2V0TGVuZ3RoID0gZnVuY3Rpb24oYnVmZmVyKSB7CiAgICByZXR1cm4gX2J5dGVzLmxlbmd0aDsKICB9OwoKICBfdGhpcy53cml0ZSA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBfYnl0ZXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgYnVmZmVyLnB1dChfYnl0ZXNbaV0sIDgpOwogICAgfQogIH07CgogIHJldHVybiBfdGhpczsKfTsKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIHFyS2FuamkKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmNvbnN0IHFyS2FuamkgPSBmdW5jdGlvbihkYXRhKSB7CgogIGNvbnN0IF9tb2RlID0gUVJNb2RlLk1PREVfS0FOSkk7CiAgY29uc3QgX2RhdGEgPSBkYXRhOwoKICBjb25zdCBzdHJpbmdUb0J5dGVzID0gcXJjb2RlLnN0cmluZ1RvQnl0ZXM7CiAgIWZ1bmN0aW9uKGMsIGNvZGUpIHsKICAgIC8vIHNlbGYgdGVzdCBmb3Igc2ppcyBzdXBwb3J0LgogICAgY29uc3QgdGVzdCA9IHN0cmluZ1RvQnl0ZXMoYyk7CiAgICBpZiAodGVzdC5sZW5ndGggIT0gMiB8fCAoICh0ZXN0WzBdIDw8IDgpIHwgdGVzdFsxXSkgIT0gY29kZSkgewogICAgICB0aHJvdyAnc2ppcyBub3Qgc3VwcG9ydGVkLic7CiAgICB9CiAgfSgnXHU1M2NiJywgMHg5NzQ2KTsKCiAgY29uc3QgX2J5dGVzID0gc3RyaW5nVG9CeXRlcyhkYXRhKTsKCiAgY29uc3QgX3RoaXMgPSB7fTsKCiAgX3RoaXMuZ2V0TW9kZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF9tb2RlOwogIH07CgogIF90aGlzLmdldExlbmd0aCA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgcmV0dXJuIH5+KF9ieXRlcy5sZW5ndGggLyAyKTsKICB9OwoKICBfdGhpcy53cml0ZSA9IGZ1bmN0aW9uKGJ1ZmZlcikgewoKICAgIGNvbnN0IGRhdGEgPSBfYnl0ZXM7CgogICAgbGV0IGkgPSAwOwoKICAgIHdoaWxlIChpICsgMSA8IGRhdGEubGVuZ3RoKSB7CgogICAgICBsZXQgYyA9ICggKDB4ZmYgJiBkYXRhW2ldKSA8PCA4KSB8ICgweGZmICYgZGF0YVtpICsgMV0pOwoKICAgICAgaWYgKDB4ODE0MCA8PSBjICYmIGMgPD0gMHg5RkZDKSB7CiAgICAgICAgYyAtPSAweDgxNDA7CiAgICAgIH0gZWxzZSBpZiAoMHhFMDQwIDw9IGMgJiYgYyA8PSAweEVCQkYpIHsKICAgICAgICBjIC09IDB4QzE0MDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyAnaWxsZWdhbCBjaGFyIGF0ICcgKyAoaSArIDEpICsgJy8nICsgYzsKICAgICAgfQoKICAgICAgYyA9ICggKGMgPj4+IDgpICYgMHhmZikgKiAweEMwICsgKGMgJiAweGZmKTsKCiAgICAgIGJ1ZmZlci5wdXQoYywgMTMpOwoKICAgICAgaSArPSAyOwogICAgfQoKICAgIGlmIChpIDwgZGF0YS5sZW5ndGgpIHsKICAgICAgdGhyb3cgJ2lsbGVnYWwgY2hhciBhdCAnICsgKGkgKyAxKTsKICAgIH0KICB9OwoKICByZXR1cm4gX3RoaXM7Cn07CgovLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQovLyBHSUYgU3VwcG9ydCBldGMuCi8vCgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBieXRlQXJyYXlPdXRwdXRTdHJlYW0KLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmNvbnN0IGJ5dGVBcnJheU91dHB1dFN0cmVhbSA9IGZ1bmN0aW9uKCkgewoKICBjb25zdCBfYnl0ZXMgPSBbXTsKCiAgY29uc3QgX3RoaXMgPSB7fTsKCiAgX3RoaXMud3JpdGVCeXRlID0gZnVuY3Rpb24oYikgewogICAgX2J5dGVzLnB1c2goYiAmIDB4ZmYpOwogIH07CgogIF90aGlzLndyaXRlU2hvcnQgPSBmdW5jdGlvbihpKSB7CiAgICBfdGhpcy53cml0ZUJ5dGUoaSk7CiAgICBfdGhpcy53cml0ZUJ5dGUoaSA+Pj4gOCk7CiAgfTsKCiAgX3RoaXMud3JpdGVCeXRlcyA9IGZ1bmN0aW9uKGIsIG9mZiwgbGVuKSB7CiAgICBvZmYgPSBvZmYgfHwgMDsKICAgIGxlbiA9IGxlbiB8fCBiLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpICs9IDEpIHsKICAgICAgX3RoaXMud3JpdGVCeXRlKGJbaSArIG9mZl0pOwogICAgfQogIH07CgogIF90aGlzLndyaXRlU3RyaW5nID0gZnVuY3Rpb24ocykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgIF90aGlzLndyaXRlQnl0ZShzLmNoYXJDb2RlQXQoaSkgKTsKICAgIH0KICB9OwoKICBfdGhpcy50b0J5dGVBcnJheSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF9ieXRlczsKICB9OwoKICBfdGhpcy50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgbGV0IHMgPSAnJzsKICAgIHMgKz0gJ1snOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBfYnl0ZXMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgaWYgKGkgPiAwKSB7CiAgICAgICAgcyArPSAnLCc7CiAgICAgIH0KICAgICAgcyArPSBfYnl0ZXNbaV07CiAgICB9CiAgICBzICs9ICddJzsKICAgIHJldHVybiBzOwogIH07CgogIHJldHVybiBfdGhpczsKfTsKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIGJhc2U2NEVuY29kZU91dHB1dFN0cmVhbQovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKY29uc3QgYmFzZTY0RW5jb2RlT3V0cHV0U3RyZWFtID0gZnVuY3Rpb24oKSB7CgogIGxldCBfYnVmZmVyID0gMDsKICBsZXQgX2J1ZmxlbiA9IDA7CiAgbGV0IF9sZW5ndGggPSAwOwogIGxldCBfYmFzZTY0ID0gJyc7CgogIGNvbnN0IF90aGlzID0ge307CgogIGNvbnN0IHdyaXRlRW5jb2RlZCA9IGZ1bmN0aW9uKGIpIHsKICAgIF9iYXNlNjQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShlbmNvZGUoYiAmIDB4M2YpICk7CiAgfTsKCiAgY29uc3QgZW5jb2RlID0gZnVuY3Rpb24obikgewogICAgaWYgKG4gPCAwKSB7CiAgICAgIHRocm93ICduOicgKyBuOwogICAgfSBlbHNlIGlmIChuIDwgMjYpIHsKICAgICAgcmV0dXJuIDB4NDEgKyBuOwogICAgfSBlbHNlIGlmIChuIDwgNTIpIHsKICAgICAgcmV0dXJuIDB4NjEgKyAobiAtIDI2KTsKICAgIH0gZWxzZSBpZiAobiA8IDYyKSB7CiAgICAgIHJldHVybiAweDMwICsgKG4gLSA1Mik7CiAgICB9IGVsc2UgaWYgKG4gPT0gNjIpIHsKICAgICAgcmV0dXJuIDB4MmI7CiAgICB9IGVsc2UgaWYgKG4gPT0gNjMpIHsKICAgICAgcmV0dXJuIDB4MmY7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyAnbjonICsgbjsKICAgIH0KICB9OwoKICBfdGhpcy53cml0ZUJ5dGUgPSBmdW5jdGlvbihuKSB7CgogICAgX2J1ZmZlciA9IChfYnVmZmVyIDw8IDgpIHwgKG4gJiAweGZmKTsKICAgIF9idWZsZW4gKz0gODsKICAgIF9sZW5ndGggKz0gMTsKCiAgICB3aGlsZSAoX2J1ZmxlbiA+PSA2KSB7CiAgICAgIHdyaXRlRW5jb2RlZChfYnVmZmVyID4+PiAoX2J1ZmxlbiAtIDYpICk7CiAgICAgIF9idWZsZW4gLT0gNjsKICAgIH0KICB9OwoKICBfdGhpcy5mbHVzaCA9IGZ1bmN0aW9uKCkgewoKICAgIGlmIChfYnVmbGVuID4gMCkgewogICAgICB3cml0ZUVuY29kZWQoX2J1ZmZlciA8PCAoNiAtIF9idWZsZW4pICk7CiAgICAgIF9idWZmZXIgPSAwOwogICAgICBfYnVmbGVuID0gMDsKICAgIH0KCiAgICBpZiAoX2xlbmd0aCAlIDMgIT0gMCkgewogICAgICAvLyBwYWRkaW5nCiAgICAgIGNvbnN0IHBhZGxlbiA9IDMgLSBfbGVuZ3RoICUgMzsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYWRsZW47IGkgKz0gMSkgewogICAgICAgIF9iYXNlNjQgKz0gJz0nOwogICAgICB9CiAgICB9CiAgfTsKCiAgX3RoaXMudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfYmFzZTY0OwogIH07CgogIHJldHVybiBfdGhpczsKfTsKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIGJhc2U2NERlY29kZUlucHV0U3RyZWFtCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpjb25zdCBiYXNlNjREZWNvZGVJbnB1dFN0cmVhbSA9IGZ1bmN0aW9uKHN0cikgewoKICBjb25zdCBfc3RyID0gc3RyOwogIGxldCBfcG9zID0gMDsKICBsZXQgX2J1ZmZlciA9IDA7CiAgbGV0IF9idWZsZW4gPSAwOwoKICBjb25zdCBfdGhpcyA9IHt9OwoKICBfdGhpcy5yZWFkID0gZnVuY3Rpb24oKSB7CgogICAgd2hpbGUgKF9idWZsZW4gPCA4KSB7CgogICAgICBpZiAoX3BvcyA+PSBfc3RyLmxlbmd0aCkgewogICAgICAgIGlmIChfYnVmbGVuID09IDApIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgJ3VuZXhwZWN0ZWQgZW5kIG9mIGZpbGUuLycgKyBfYnVmbGVuOwogICAgICB9CgogICAgICBjb25zdCBjID0gX3N0ci5jaGFyQXQoX3Bvcyk7CiAgICAgIF9wb3MgKz0gMTsKCiAgICAgIGlmIChjID09ICc9JykgewogICAgICAgIF9idWZsZW4gPSAwOwogICAgICAgIHJldHVybiAtMTsKICAgICAgfSBlbHNlIGlmIChjLm1hdGNoKC9eXHMkLykgKSB7CiAgICAgICAgLy8gaWdub3JlIGlmIHdoaXRlc3BhY2UuCiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIF9idWZmZXIgPSAoX2J1ZmZlciA8PCA2KSB8IGRlY29kZShjLmNoYXJDb2RlQXQoMCkgKTsKICAgICAgX2J1ZmxlbiArPSA2OwogICAgfQoKICAgIGNvbnN0IG4gPSAoX2J1ZmZlciA+Pj4gKF9idWZsZW4gLSA4KSApICYgMHhmZjsKICAgIF9idWZsZW4gLT0gODsKICAgIHJldHVybiBuOwogIH07CgogIGNvbnN0IGRlY29kZSA9IGZ1bmN0aW9uKGMpIHsKICAgIGlmICgweDQxIDw9IGMgJiYgYyA8PSAweDVhKSB7CiAgICAgIHJldHVybiBjIC0gMHg0MTsKICAgIH0gZWxzZSBpZiAoMHg2MSA8PSBjICYmIGMgPD0gMHg3YSkgewogICAgICByZXR1cm4gYyAtIDB4NjEgKyAyNjsKICAgIH0gZWxzZSBpZiAoMHgzMCA8PSBjICYmIGMgPD0gMHgzOSkgewogICAgICByZXR1cm4gYyAtIDB4MzAgKyA1MjsKICAgIH0gZWxzZSBpZiAoYyA9PSAweDJiKSB7CiAgICAgIHJldHVybiA2MjsKICAgIH0gZWxzZSBpZiAoYyA9PSAweDJmKSB7CiAgICAgIHJldHVybiA2MzsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93ICdjOicgKyBjOwogICAgfQogIH07CgogIHJldHVybiBfdGhpczsKfTsKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIGdpZkltYWdlIChCL1cpCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpjb25zdCBnaWZJbWFnZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKCiAgY29uc3QgX3dpZHRoID0gd2lkdGg7CiAgY29uc3QgX2hlaWdodCA9IGhlaWdodDsKICBjb25zdCBfZGF0YSA9IG5ldyBBcnJheSh3aWR0aCAqIGhlaWdodCk7CgogIGNvbnN0IF90aGlzID0ge307CgogIF90aGlzLnNldFBpeGVsID0gZnVuY3Rpb24oeCwgeSwgcGl4ZWwpIHsKICAgIF9kYXRhW3kgKiBfd2lkdGggKyB4XSA9IHBpeGVsOwogIH07CgogIF90aGlzLndyaXRlID0gZnVuY3Rpb24ob3V0KSB7CgogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEdJRiBTaWduYXR1cmUKCiAgICBvdXQud3JpdGVTdHJpbmcoJ0dJRjg3YScpOwoKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBTY3JlZW4gRGVzY3JpcHRvcgoKICAgIG91dC53cml0ZVNob3J0KF93aWR0aCk7CiAgICBvdXQud3JpdGVTaG9ydChfaGVpZ2h0KTsKCiAgICBvdXQud3JpdGVCeXRlKDB4ODApOyAvLyAyYml0CiAgICBvdXQud3JpdGVCeXRlKDApOwogICAgb3V0LndyaXRlQnl0ZSgwKTsKCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gR2xvYmFsIENvbG9yIE1hcAoKICAgIC8vIGJsYWNrCiAgICBvdXQud3JpdGVCeXRlKDB4MDApOwogICAgb3V0LndyaXRlQnl0ZSgweDAwKTsKICAgIG91dC53cml0ZUJ5dGUoMHgwMCk7CgogICAgLy8gd2hpdGUKICAgIG91dC53cml0ZUJ5dGUoMHhmZik7CiAgICBvdXQud3JpdGVCeXRlKDB4ZmYpOwogICAgb3V0LndyaXRlQnl0ZSgweGZmKTsKCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gSW1hZ2UgRGVzY3JpcHRvcgoKICAgIG91dC53cml0ZVN0cmluZygnLCcpOwogICAgb3V0LndyaXRlU2hvcnQoMCk7CiAgICBvdXQud3JpdGVTaG9ydCgwKTsKICAgIG91dC53cml0ZVNob3J0KF93aWR0aCk7CiAgICBvdXQud3JpdGVTaG9ydChfaGVpZ2h0KTsKICAgIG91dC53cml0ZUJ5dGUoMCk7CgogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIExvY2FsIENvbG9yIE1hcAoKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBSYXN0ZXIgRGF0YQoKICAgIGNvbnN0IGx6d01pbkNvZGVTaXplID0gMjsKICAgIGNvbnN0IHJhc3RlciA9IGdldExaV1Jhc3RlcihsendNaW5Db2RlU2l6ZSk7CgogICAgb3V0LndyaXRlQnl0ZShsendNaW5Db2RlU2l6ZSk7CgogICAgbGV0IG9mZnNldCA9IDA7CgogICAgd2hpbGUgKHJhc3Rlci5sZW5ndGggLSBvZmZzZXQgPiAyNTUpIHsKICAgICAgb3V0LndyaXRlQnl0ZSgyNTUpOwogICAgICBvdXQud3JpdGVCeXRlcyhyYXN0ZXIsIG9mZnNldCwgMjU1KTsKICAgICAgb2Zmc2V0ICs9IDI1NTsKICAgIH0KCiAgICBvdXQud3JpdGVCeXRlKHJhc3Rlci5sZW5ndGggLSBvZmZzZXQpOwogICAgb3V0LndyaXRlQnl0ZXMocmFzdGVyLCBvZmZzZXQsIHJhc3Rlci5sZW5ndGggLSBvZmZzZXQpOwogICAgb3V0LndyaXRlQnl0ZSgweDAwKTsKCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gR0lGIFRlcm1pbmF0b3IKICAgIG91dC53cml0ZVN0cmluZygnOycpOwogIH07CgogIGNvbnN0IGJpdE91dHB1dFN0cmVhbSA9IGZ1bmN0aW9uKG91dCkgewoKICAgIGNvbnN0IF9vdXQgPSBvdXQ7CiAgICBsZXQgX2JpdExlbmd0aCA9IDA7CiAgICBsZXQgX2JpdEJ1ZmZlciA9IDA7CgogICAgY29uc3QgX3RoaXMgPSB7fTsKCiAgICBfdGhpcy53cml0ZSA9IGZ1bmN0aW9uKGRhdGEsIGxlbmd0aCkgewoKICAgICAgaWYgKCAoZGF0YSA+Pj4gbGVuZ3RoKSAhPSAwKSB7CiAgICAgICAgdGhyb3cgJ2xlbmd0aCBvdmVyJzsKICAgICAgfQoKICAgICAgd2hpbGUgKF9iaXRMZW5ndGggKyBsZW5ndGggPj0gOCkgewogICAgICAgIF9vdXQud3JpdGVCeXRlKDB4ZmYgJiAoIChkYXRhIDw8IF9iaXRMZW5ndGgpIHwgX2JpdEJ1ZmZlcikgKTsKICAgICAgICBsZW5ndGggLT0gKDggLSBfYml0TGVuZ3RoKTsKICAgICAgICBkYXRhID4+Pj0gKDggLSBfYml0TGVuZ3RoKTsKICAgICAgICBfYml0QnVmZmVyID0gMDsKICAgICAgICBfYml0TGVuZ3RoID0gMDsKICAgICAgfQoKICAgICAgX2JpdEJ1ZmZlciA9IChkYXRhIDw8IF9iaXRMZW5ndGgpIHwgX2JpdEJ1ZmZlcjsKICAgICAgX2JpdExlbmd0aCA9IF9iaXRMZW5ndGggKyBsZW5ndGg7CiAgICB9OwoKICAgIF90aGlzLmZsdXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChfYml0TGVuZ3RoID4gMCkgewogICAgICAgIF9vdXQud3JpdGVCeXRlKF9iaXRCdWZmZXIpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBfdGhpczsKICB9OwoKICBjb25zdCBnZXRMWldSYXN0ZXIgPSBmdW5jdGlvbihsendNaW5Db2RlU2l6ZSkgewoKICAgIGNvbnN0IGNsZWFyQ29kZSA9IDEgPDwgbHp3TWluQ29kZVNpemU7CiAgICBjb25zdCBlbmRDb2RlID0gKDEgPDwgbHp3TWluQ29kZVNpemUpICsgMTsKICAgIGxldCBiaXRMZW5ndGggPSBsendNaW5Db2RlU2l6ZSArIDE7CgogICAgLy8gU2V0dXAgTFpXVGFibGUKICAgIGNvbnN0IHRhYmxlID0gbHp3VGFibGUoKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNsZWFyQ29kZTsgaSArPSAxKSB7CiAgICAgIHRhYmxlLmFkZChTdHJpbmcuZnJvbUNoYXJDb2RlKGkpICk7CiAgICB9CiAgICB0YWJsZS5hZGQoU3RyaW5nLmZyb21DaGFyQ29kZShjbGVhckNvZGUpICk7CiAgICB0YWJsZS5hZGQoU3RyaW5nLmZyb21DaGFyQ29kZShlbmRDb2RlKSApOwoKICAgIGNvbnN0IGJ5dGVPdXQgPSBieXRlQXJyYXlPdXRwdXRTdHJlYW0oKTsKICAgIGNvbnN0IGJpdE91dCA9IGJpdE91dHB1dFN0cmVhbShieXRlT3V0KTsKCiAgICAvLyBjbGVhciBjb2RlCiAgICBiaXRPdXQud3JpdGUoY2xlYXJDb2RlLCBiaXRMZW5ndGgpOwoKICAgIGxldCBkYXRhSW5kZXggPSAwOwoKICAgIGxldCBzID0gU3RyaW5nLmZyb21DaGFyQ29kZShfZGF0YVtkYXRhSW5kZXhdKTsKICAgIGRhdGFJbmRleCArPSAxOwoKICAgIHdoaWxlIChkYXRhSW5kZXggPCBfZGF0YS5sZW5ndGgpIHsKCiAgICAgIGNvbnN0IGMgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKF9kYXRhW2RhdGFJbmRleF0pOwogICAgICBkYXRhSW5kZXggKz0gMTsKCiAgICAgIGlmICh0YWJsZS5jb250YWlucyhzICsgYykgKSB7CgogICAgICAgIHMgPSBzICsgYzsKCiAgICAgIH0gZWxzZSB7CgogICAgICAgIGJpdE91dC53cml0ZSh0YWJsZS5pbmRleE9mKHMpLCBiaXRMZW5ndGgpOwoKICAgICAgICBpZiAodGFibGUuc2l6ZSgpIDwgMHhmZmYpIHsKCiAgICAgICAgICBpZiAodGFibGUuc2l6ZSgpID09ICgxIDw8IGJpdExlbmd0aCkgKSB7CiAgICAgICAgICAgIGJpdExlbmd0aCArPSAxOwogICAgICAgICAgfQoKICAgICAgICAgIHRhYmxlLmFkZChzICsgYyk7CiAgICAgICAgfQoKICAgICAgICBzID0gYzsKICAgICAgfQogICAgfQoKICAgIGJpdE91dC53cml0ZSh0YWJsZS5pbmRleE9mKHMpLCBiaXRMZW5ndGgpOwoKICAgIC8vIGVuZCBjb2RlCiAgICBiaXRPdXQud3JpdGUoZW5kQ29kZSwgYml0TGVuZ3RoKTsKCiAgICBiaXRPdXQuZmx1c2goKTsKCiAgICByZXR1cm4gYnl0ZU91dC50b0J5dGVBcnJheSgpOwogIH07CgogIGNvbnN0IGx6d1RhYmxlID0gZnVuY3Rpb24oKSB7CgogICAgY29uc3QgX21hcCA9IHt9OwogICAgbGV0IF9zaXplID0gMDsKCiAgICBjb25zdCBfdGhpcyA9IHt9OwoKICAgIF90aGlzLmFkZCA9IGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoX3RoaXMuY29udGFpbnMoa2V5KSApIHsKICAgICAgICB0aHJvdyAnZHVwIGtleTonICsga2V5OwogICAgICB9CiAgICAgIF9tYXBba2V5XSA9IF9zaXplOwogICAgICBfc2l6ZSArPSAxOwogICAgfTsKCiAgICBfdGhpcy5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfc2l6ZTsKICAgIH07CgogICAgX3RoaXMuaW5kZXhPZiA9IGZ1bmN0aW9uKGtleSkgewogICAgICByZXR1cm4gX21hcFtrZXldOwogICAgfTsKCiAgICBfdGhpcy5jb250YWlucyA9IGZ1bmN0aW9uKGtleSkgewogICAgICByZXR1cm4gdHlwZW9mIF9tYXBba2V5XSAhPSAndW5kZWZpbmVkJzsKICAgIH07CgogICAgcmV0dXJuIF90aGlzOwogIH07CgogIHJldHVybiBfdGhpczsKfTsKCmNvbnN0IGNyZWF0ZURhdGFVUkwgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCBnZXRQaXhlbCkgewogIGNvbnN0IGdpZiA9IGdpZkltYWdlKHdpZHRoLCBoZWlnaHQpOwogIGZvciAobGV0IHkgPSAwOyB5IDwgaGVpZ2h0OyB5ICs9IDEpIHsKICAgIGZvciAobGV0IHggPSAwOyB4IDwgd2lkdGg7IHggKz0gMSkgewogICAgICBnaWYuc2V0UGl4ZWwoeCwgeSwgZ2V0UGl4ZWwoeCwgeSkgKTsKICAgIH0KICB9CgogIGNvbnN0IGIgPSBieXRlQXJyYXlPdXRwdXRTdHJlYW0oKTsKICBnaWYud3JpdGUoYik7CgogIGNvbnN0IGJhc2U2NCA9IGJhc2U2NEVuY29kZU91dHB1dFN0cmVhbSgpOwogIGNvbnN0IGJ5dGVzID0gYi50b0J5dGVBcnJheSgpOwogIGZvciAobGV0IGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoOyBpICs9IDEpIHsKICAgIGJhc2U2NC53cml0ZUJ5dGUoYnl0ZXNbaV0pOwogIH0KICBiYXNlNjQuZmx1c2goKTsKCiAgcmV0dXJuICdkYXRhOmltYWdlL2dpZjtiYXNlNjQsJyArIGJhc2U2NDsKfTsKCmV4cG9ydCBkZWZhdWx0IHFyY29kZTsKCmV4cG9ydCBjb25zdCBzdHJpbmdUb0J5dGVzID0gcXJjb2RlLnN0cmluZ1RvQnl0ZXM7Cg==");return g}async drawQRCode(g,I,C,A,o=this.getBlockIdByName("Coal"),S=this.getBlockIdByName("Ice")){if(!g||0===g.length)throw new Error("QR code text cannot be empty");const s=(await this.getQRCodeModule())(0,"L");s.addData(g),s.make();const t=s.getModuleCount(),d=t+8;console.log(`📱 Generating ${t}x${t} QR code (total: ${d}x${d} with margin)`);const i=[];for(let g=0;g<d;g++)for(let o=0;o<d;o++)i.push({x:I+o,y:C+g,z:A,block:S});for(let g=0;g<t;g++)for(let d=0;d<t;d++){const t=s.isDark(g,d)?o:S;i.push({x:I+4+d,y:C+4+g,z:A,block:t})}return this.batchSetBlocks(i),{x:I,y:C,z:A,width:d,height:d,data:s.createDataURL(),size:t,totalSize:d}}async holdKey(g){this.shadow.dispatchEvent(d("keydown",g))}async releaseKey(g){this.shadow.dispatchEvent(d("keyup",g))}async releaseAllKeys(g,I=50){for(const I of g)await this.releaseKey(I);await C(I)}async pressKeyRepeat(g,I,A=100){for(let o=0;o<I;o++)await i(this.shadow,g,A/2),await C(A)}async pressKeySequence(g,I=100,A=void 0){for(const o of g)A&&A(o),await i(this.shadow,o,I/2),await C(I)}showFullScreen(){const g=this.shadow.getElementById("resolutionSelect"),I=g.querySelector('[value="fullscreen"]');I?.removeAttribute("hidden"),g instanceof HTMLSelectElement&&(g.value="fullscreen")}setFullscreen(){this.showFullScreen(),this.config.currentResolution.set("fullscreen"),function(g,I){const C=g.getElementById("canvas");if(C instanceof HTMLCanvasElement){const A=I.get();if("fullscreen"===A)return g.host.classList.remove("resolution","resolution-400","resolution-600","resolution-800"),C.width=globalThis.innerWidth,C.height=globalThis.innerHeight,C.style.width="100vw",C.style.width="100dvw",C.style.height="100vh",void(C.style.height="100dvh");g.host.classList.add("resolution"),g.host.classList.remove("resolution-400","resolution-600","resolution-800");const o=parseInt(A);C.width=o,C.height=o,C.style.width=o+"px",C.style.height=o+"px",g.host.classList.add(`resolution-${o}`)}}(this.shadow,this.config.currentResolution)}extractBlockKey(g){const I=g.match(/--bg-(block|color)-(.+?)(?:-color)?$/i);if(I){const g=this.normalizeBlockName(I[2]);return L[g]?g:null}return null}}class b extends K{createFirework(g,I,C,A,o={}){g=Math.floor(g),I=Math.floor(I),C=Math.floor(C),A=Math.floor(A);const{explosionRadius:S=7,explosionDuration:s=20,colors:t=["Gold","Ice","Snow","Rose Bloom","Lavender Flowers","Sunflower Petals","Tulip Petals"],rocketBlock:d="Iron",rocketSpeed:i=.8}=o,L=t.map(g=>this.getBlockIdByName(g)).filter(g=>-1!==g);0===L.length&&L.push(this.getBlockIdByName("Gold"));const l=this.getBlockIdByName(d),G=this.getBlockIdByName("Air");let B=I,c="rocket",K=[];const b=()=>{const I=[];if("rocket"===c)I.push({x:g,y:Math.floor(B),z:A,block:G}),B+=i,B<C?I.push({x:g,y:Math.floor(B),z:A,block:l}):(c="explode",this.initExplosion(g,Math.floor(B),A,L,S,K));else if("explode"===c&&(K.forEach(g=>{I.push({x:Math.floor(g.x),y:Math.floor(g.y),z:Math.floor(g.z),block:G})}),K.forEach(g=>{g.x+=g.vx,g.y+=g.vy,g.z+=g.vz,g.vy-=.05,g.vx*=.95,g.vz*=.95,g.life--}),K=K.filter(g=>g.life>0),K.forEach(g=>{g.life>0&&I.push({x:Math.floor(g.x),y:Math.floor(g.y),z:Math.floor(g.z),block:g.block})}),0===K.length))return void this.batchSetBlocks(I);this.batchSetBlocks(I),requestAnimationFrame(b)};b()}initExplosion(I,C,A,o,S,s){for(let S=0;S<50;S++){const S=Math.random()*Math.PI*2,t=2*Math.random()-1,d=.5*Math.random()+.2,i=Math.sqrt(1-t*t)*Math.cos(S)*d,L=Math.sqrt(1-t*t)*Math.sin(S)*d,l=t*d;s.push({x:I,y:C,z:A,vx:i,vy:L,vz:l,block:o[Math.floor(Math.random()*o.length)],life:g(20,50)})}}createFireworksShow(I={}){const{count:C=10,duration:A=8e3,xMin:o=5,xMax:S=25,yStart:s=64,yMinTarget:t=100,yMaxTarget:d=120,zMin:i=10,zMax:L=30,delay:l=0}=I;setTimeout(()=>{for(let I=0;I<C;I++){const I=g(o,S),C=g(t,d),l=g(i,L);setTimeout(()=>{this.createFirework(I,s,C,l)},g(0,A))}},l)}}async function Z(){const g=new b;await g.setFullscreen(),console.log("🎮 BlockGarden Demo: Fireworks (Improved)"),g.createFireworksShow();console.log("🧬 Fireworks started!"),console.log("💡 Use blockGarden.demo.fireworksAPI.createFireworksShow() to enjoy another!"),g.gThis.blockGarden.demo={...g.gThis.blockGarden.demo,fireworksAPI:g}}function n(g){g&&g.parentElement&&(g.classList.add("toast--slide-out"),setTimeout(()=>g.remove(),300))}function e(g,I,C={}){const{duration:A=3e3,manualClose:o=!1,stack:S=!1,bottomOffset:s=1,useSingle:t=!0}=C,d=g.getElementById("toastContainer");if(!d)return void console.warn("Toast container not found");let i;if(d.style.bottom=`${s}rem`,t&&(i=d.querySelector(".toast"),i)){const g=i.querySelector(".toast__content");if(g&&(g.textContent=I),A>0){const g=i;clearTimeout(g.autoRemoveTimer),g.autoRemoveTimer=setTimeout(()=>n(i),A)}return}if(!S&&!t){d.querySelectorAll(".toast").forEach(g=>{g.classList.add("toast--fade-out"),setTimeout(()=>g.remove(),300)})}i=g.ownerDocument.createElement("div"),i.className="toast";const L=g.ownerDocument.createElement("div");if(L.className="toast__content",L.textContent=I,i.appendChild(L),o){const I=g.ownerDocument.createElement("button");I.className="toast__close-btn",I.innerHTML="&times;",I.addEventListener("click",()=>n(i)),i.appendChild(I)}if(d.appendChild(i),A>0){i.autoRemoveTimer=setTimeout(()=>n(i),A)}}class w extends K{async start(){let g="";await this.pressKeySequence([38,38,40,40,37,39,37,39,66,65],150,I=>{switch(I){case 38:g="Up";break;case 40:g="Down";break;case 37:g="Left";break;case 39:g="Right";break;case 66:g="B";break;case 65:g="A"}e(this.shadow,g)})}}async function a(g='#settings > [class="ui-grid__corner--heading"]'){const I=new w;await I.setFullscreen();const A=I.shadow.querySelector(g);A instanceof HTMLDivElement&&A.click(),console.log("🎮 BlockGarden Demo: KonamiCode"),console.log("🧬 KonamiCode started!"),e(I.shadow,"Beginning Konami Code sequence"),await C(2e3),await I.start();console.log("💡 Use blockGarden.demo.konamiCodeAPI.start() to ... well, run the demo again! :-)"),I.gThis.blockGarden.demo={...I.gThis.blockGarden.demo,konamiCodeAPI:I}}class m extends K{constructor(){super()}async init(g="Block",C="Garden",A="Snow",o="Coal",S=15,s=76,t=45,d=15,i=70,L=45,l=180){try{const G=this.getBlockIdByName(A),B=this.getBlockIdByName(o),c=this.drawText(g,S,s,t,G,B,1,I,l),K=this.drawText(C,d,i,L,G,B,1,I,l);e(this.shadow,"The text has been drawn successfully!"),setTimeout(()=>e(this.shadow,"Look up toward the clouds ↑↑↑"),4e3),setTimeout(()=>e(this.shadow,"Look up toward the clouds ↑↑↑"),8e3),console.log("✓ Text drawn successfully!"),console.log(`  Position: (${c.x}, ${c.y}, ${c.z})`),console.log(`  Size: ${c.width}x${c.height} blocks`),console.log(`  Position: (${K.x}, ${K.y}, ${K.z})`),console.log(`  Size: ${K.width}x${K.height} blocks`)}catch(g){console.error("Error drawing text:",g)}}}async function y(){let g=0;for(;!globalThis.blockGarden&&g<100;)await new Promise(g=>setTimeout(g,100)),g++;if(!globalThis.blockGarden)return void console.error("blockGarden not initialized. Make sure the game has loaded.");const I=new m;globalThis.Messaging=I,"function"==typeof I.setFullscreen&&await I.setFullscreen(),console.log("🎮 BlockGarden Demo: Messaging"),await I.init();console.log("🧬 Messaging started!"),console.log("💡 Use blockGarden.demo.messagingAPI.init() to demo again!"),I.gThis.blockGarden.demo={...I.gThis.blockGarden.demo||{},messagingAPI:I}}export{b as Fireworks,Z as FireworksDemo,w as KonamiCode,a as KonamiCodeDemo,m as Messaging,y as MessagingDemo};
